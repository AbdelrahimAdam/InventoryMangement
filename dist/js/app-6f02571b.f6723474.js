"use strict";(self["webpackChunkmonofia_perfume_inventory"]=self["webpackChunkmonofia_perfume_inventory"]||[]).push([[834],{203:function(e,r,t){var s=t(2405),a=t(1032),o=t(3556);class n{constructor(){this.usersCollection="users",this.logsCollection="user_logs",this.profilesCollection="user_profiles"}async _checkSuperAdminPermission(){try{if(!o.j2.currentUser)throw new Error("يجب تسجيل الدخول أولاً");const e=await(0,s.x7)((0,s.H9)(o.db,this.usersCollection,o.j2.currentUser.uid));if(!e.exists())throw new Error("ملف المستخدم غير موجود");const r=e.data();if("superadmin"!==r.role)throw new Error("ليس لديك صلاحية لإدارة المستخدمين");return r}catch(e){throw console.error("Permission check error:",e),e}}async getUsers(e={}){try{await this._checkSuperAdminPermission();const{page:r=1,limit:t=20,search:a="",role:n="",is_active:i=null,sort_by:c="created_at",sort_order:u="desc"}=e;let l=(0,s.rJ)(o.db,this.usersCollection);const d=[];n&&d.push((0,s._M)("role","==",n)),null!==i&&d.push((0,s._M)("is_active","==",i)),d.push((0,s.My)(c,u)),l=(0,s.P)(l,...d);const _=await(0,s.GG)(l);let m=[];_.forEach(e=>{const r=e.data();this._userMatchesSearch(r,a)&&m.push({id:e.id,...r,created_at:this._formatTimestamp(r.created_at),updated_at:this._formatTimestamp(r.updated_at),last_login:this._formatTimestamp(r.last_login)})});const h=m.length,w=(r-1)*t,p=m.slice(w,w+t);return{success:!0,data:p,pagination:{currentPage:r,totalPages:Math.ceil(h/t),totalItems:h,itemsPerPage:t}}}catch(r){return console.error("UserService.getUsers Error:",r),{success:!1,error:this._handleFirebaseError(r),data:[],pagination:{currentPage:1,totalPages:0,totalItems:0,itemsPerPage:20}}}}async getUserById(e){try{const r=(0,s.H9)(o.db,this.usersCollection,e),t=await(0,s.x7)(r);if(!t.exists())return{success:!1,error:"المستخدم غير موجود",data:null};const a=t.data(),n={id:t.id,...a,created_at:this._formatTimestamp(a.created_at),updated_at:this._formatTimestamp(a.updated_at),last_login:this._formatTimestamp(a.last_login)};return{success:!0,data:n,message:"تم تحميل المستخدم بنجاح"}}catch(r){return console.error("UserService.getUserById Error:",r),{success:!1,error:this._handleFirebaseError(r),data:null}}}async createUser(e){try{console.log("UserService.createUser called with:",e),await this._checkSuperAdminPermission();const r=this.validateUserData(e,!1);if(!r.isValid)return console.error("Validation errors:",r.errors),{success:!1,error:r.errors[0],data:null};const t=await(0,a.eJ)(o.j2,e.email.trim().toLowerCase(),e.password),n=t.user,i=n.uid,c=this.getDefaultPermissionsForRole(e.role),u={name:e.name?e.name.trim():"",email:e.email?e.email.trim().toLowerCase():"",phone:e.phone?e.phone.trim():null,role:e.role||"company_manager",is_active:!1!==e.is_active,permissions:Array.isArray(e.permissions)&&e.permissions.length>0?e.permissions:c,allowed_warehouses:"warehouse_manager"===e.role&&Array.isArray(e.allowed_warehouses)?e.allowed_warehouses:[],created_at:(0,s.O5)(),updated_at:(0,s.O5)(),created_by:o.j2.currentUser?.uid||"system",email_verified:!1,last_login:null,profile_complete:!0};console.log("Creating user document:",u),await(0,a.r7)(n,{displayName:u.name}),await(0,a.gA)(n);const l=(0,s.H9)(o.db,this.usersCollection,i);await(0,s.BN)(l,u);const d=(0,s.H9)(o.db,this.profilesCollection,i);return await(0,s.BN)(d,{user_id:i,preferences:{language:"ar",theme:"light",notifications:!0},created_at:(0,s.O5)(),updated_at:(0,s.O5)()}),await this._logUserAction("create",i,{name:u.name,email:u.email,role:u.role,permissions:u.permissions,allowed_warehouses:u.allowed_warehouses}),{success:!0,data:{id:i,...u,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},message:"تم إنشاء المستخدم بنجاح"}}catch(r){return console.error("UserService.createUser Error:",r),{success:!1,error:this._handleFirebaseError(r),data:null}}}async updateUser(e,r){try{console.log("UserService.updateUser called for:",e,"with data:",r),await this._checkSuperAdminPermission();const n=await this.getUserById(e);if(!n.success)return n;const i=this.validateUserData(r,!0);if(!i.isValid)return{success:!1,error:i.errors[0],data:null};const c={name:r.name?r.name.trim():n.data.name,phone:r.phone?r.phone.trim():n.data.phone||null,role:r.role||n.data.role,is_active:!1!==r.is_active,permissions:Array.isArray(r.permissions)&&r.permissions.length>0?r.permissions:n.data.permissions||[],allowed_warehouses:"warehouse_manager"===r.role&&Array.isArray(r.allowed_warehouses)?r.allowed_warehouses:[],updated_at:(0,s.O5)(),updated_by:o.j2.currentUser?.uid};if(console.log("Updating user with data:",c),r.name&&r.name!==n.data.name)try{const r=o.j2.currentUser;r?.uid===e&&await(0,a.r7)(r,{displayName:c.name})}catch(t){console.warn("Could not update Firebase Auth profile:",t)}const u=(0,s.H9)(o.db,this.usersCollection,e);return await(0,s.mZ)(u,c),await this._logUserAction("update",e,{name:c.name,role:c.role,is_active:c.is_active,permissions:c.permissions,allowed_warehouses:c.allowed_warehouses}),{success:!0,data:{...n.data,...c,updated_at:(new Date).toISOString()},message:"تم تحديث المستخدم بنجاح"}}catch(t){return console.error("UserService.updateUser Error:",t),{success:!1,error:this._handleFirebaseError(t),data:null}}}async deleteUser(e){try{await this._checkSuperAdminPermission();const r=(0,s.H9)(o.db,this.usersCollection,e),t=await(0,s.x7)(r);if(!t.exists())return{success:!1,error:"المستخدم غير موجود"};if(o.j2.currentUser?.uid===e)return{success:!1,error:"لا يمكن حذف حسابك الشخصي"};const a=t.data();if("superadmin"===a.role)return{success:!1,error:"لا يمكن حذف مشرف عام آخر"};await(0,s.kd)(r);const n=(0,s.H9)(o.db,this.profilesCollection,e);return await(0,s.kd)(n),await this._logUserAction("delete",e,{name:a.name||"غير معروف",email:a.email||"غير معروف"}),{success:!0,message:"تم حذف المستخدم بنجاح"}}catch(r){return console.error("UserService.deleteUser Error:",r),{success:!1,error:this._handleFirebaseError(r)}}}async updateUserStatus(e,r){try{await this._checkSuperAdminPermission();const t=(0,s.H9)(o.db,this.usersCollection,e),a=await(0,s.x7)(t);if(!a.exists())return{success:!1,error:"المخدم غير موجود"};const n=a.data();return o.j2.currentUser?.uid===e&&"superadmin"===n.role?{success:!1,error:"لا يمكن تعطيل حساب المشرف العام"}:r||"superadmin"!==n.role?(await(0,s.mZ)(t,{is_active:r,updated_at:(0,s.O5)(),updated_by:o.j2.currentUser?.uid}),await this._logUserAction(r?"activate":"deactivate",e,{name:n.name||"غير معروف",previous_status:n.is_active,new_status:r}),{success:!0,message:`تم ${r?"تفعيل":"تعطيل"} المستخدم بنجاح`}):{success:!1,error:"لا يمكن تعطيل مشرف عام آخر"}}catch(t){return console.error("UserService.updateUserStatus Error:",t),{success:!1,error:this._handleFirebaseError(t)}}}async searchUsers(e,r=10){try{await this._checkSuperAdminPermission();const t=(0,s.rJ)(o.db,this.usersCollection),a=await(0,s.GG)(t),n=[];a.forEach(r=>{const t=r.data();this._userMatchesSearch(t,e)&&n.push({id:r.id,...t,created_at:this._formatTimestamp(t.created_at),updated_at:this._formatTimestamp(t.updated_at)})});const i=n.sort((r,t)=>{const s=this._calculateSearchScore(r,e),a=this._calculateSearchScore(t,e);return a-s});return{success:!0,data:i.slice(0,r),message:"تم البحث بنجاح"}}catch(t){return console.error("UserService.searchUsers Error:",t),{success:!1,error:this._handleFirebaseError(t),data:[]}}}async getUserStats(){try{await this._checkSuperAdminPermission();const e=(0,s.rJ)(o.db,this.usersCollection),r=await(0,s.GG)(e);let t=0,a=0,n=0,i=0,c=0;return r.forEach(e=>{const r=e.data();switch(t++,!1!==r.is_active&&a++,r.role){case"superadmin":n++;break;case"warehouse_manager":i++;break;case"company_manager":c++;break}}),{success:!0,data:{total_users:t,active_users:a,inactive_users:t-a,superadmins:n,warehouse_managers:i,company_managers:c,roles_distribution:{superadmin:n,warehouse_manager:i,company_manager:c}}}}catch(e){return console.error("UserService.getUserStats Error:",e),{success:!1,error:this._handleFirebaseError(e),data:null}}}generateRandomPassword(e=12){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";let t="";for(let s=0;s<e;s++){const e=Math.floor(Math.random()*r.length);t+=r[e]}return t}async _logUserAction(e,r,t=null){try{const a=(0,s.rJ)(o.db,this.logsCollection),n={action:e,user_id:r,performed_by:o.j2.currentUser?.uid||"system",performed_by_name:o.j2.currentUser?.displayName||"System",data:t?JSON.stringify(t):null,timestamp:(0,s.O5)(),ip_address:"unknown"};await(0,s.BN)((0,s.H9)(a),n)}catch(a){console.error("Failed to log user action:",a)}}_userMatchesSearch(e,r){if(!r||"string"!==typeof r)return!0;const t=r.toLowerCase().trim();if(!t)return!0;const s=(e.name||"").toLowerCase(),a=(e.email||"").toLowerCase(),o=(e.phone||"").toLowerCase();return s.includes(t)||a.includes(t)||o.includes(t)}_calculateSearchScore(e,r){if(!e||!r||"string"!==typeof r)return 0;let t=0;const s=r.toLowerCase().trim();return e.name&&"string"===typeof e.name&&e.name.toLowerCase().includes(s)&&(t+=3),e.email&&"string"===typeof e.email&&e.email.toLowerCase().includes(s)&&(t+=2),e.phone&&"string"===typeof e.phone&&e.phone.toLowerCase().includes(s)&&(t+=1),t}_formatTimestamp(e){return e?e instanceof s.Dc||e.toDate?e.toDate().toISOString():e:null}_handleFirebaseError(e){if(!e)return"حدث خطأ غير معروف";console.error("Firebase Error:",e.code,e.message);const r={"auth/email-already-in-use":"البريد الإلكتروني مسجل مسبقاً","auth/invalid-email":"البريد الإلكتروني غير صالح","auth/operation-not-allowed":"عملية غير مسموحة","auth/weak-password":"كلمة المرور ضعيفة جداً","auth/user-disabled":"هذا الحساب معطل","auth/user-not-found":"المستخدم غير موجود","auth/wrong-password":"كلمة المرور غير صحيحة","auth/too-many-requests":"محاولات كثيرة جداً، يرجى الانتظار","permission-denied":"ليس لديك صلاحية للقيام بهذا الإجراء","not-found":"المستند غير موجود","already-exists":"المستند موجود مسبقاً",unavailable:"الخدمة غير متاحة حالياً"};return e.code&&r[e.code]?r[e.code]:e.message||"حدث خطأ غير متوقع"}validateUserData(e,r=!1){const t=[];if(!e||"object"!==typeof e)return{isValid:!1,errors:["بيانات المستخدم غير صالحة"]};if((!e.name||"string"!==typeof e.name||e.name.trim().length<2)&&t.push("الاسم يجب أن يكون على الأقل حرفين"),!r||e.email){const r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;e.email&&"string"===typeof e.email&&r.test(e.email.trim())||t.push("البريد الإلكتروني غير صالح")}if(e.phone&&"string"===typeof e.phone&&e.phone.trim()){const r=/^01[0-9]{9}$/;r.test(e.phone.trim())||t.push("رقم الهاتف يجب أن يبدأ بـ 01 ويتكون من 11 رقماً")}const s=["superadmin","warehouse_manager","company_manager"];return e.role&&s.includes(e.role)||t.push("الدور غير صالح"),r||(!e.password||"string"!==typeof e.password||e.password.length<8)&&t.push("كلمة المرور يجب أن تكون 8 أحرف على الأقل"),"warehouse_manager"===e.role&&(Array.isArray(e.allowed_warehouses)&&0!==e.allowed_warehouses.length||t.push("يجب اختيار مخزن واحد على الأقل لمدير المخازن")),e.permissions&&!Array.isArray(e.permissions)&&t.push("صلاحيات المستخدم يجب أن تكون مصفوفة"),{isValid:0===t.length,errors:t}}formatUserForDisplay(e){return e&&"object"===typeof e?{id:e.id||"غير معروف",name:e.name||"غير معروف",email:e.email||"",phone:e.phone||"-",role:e.role||"user",role_name:this.getRoleName(e.role),is_active:!1!==e.is_active,status:!1!==e.is_active?"نشط":"غير نشط",status_color:!1!==e.is_active?"green":"red",allowed_warehouses:Array.isArray(e.allowed_warehouses)?e.allowed_warehouses:[],permissions:Array.isArray(e.permissions)?e.permissions:[],created_at:e.created_at?new Date(e.created_at).toLocaleDateString("ar-EG"):"-",updated_at:e.updated_at?new Date(e.updated_at).toLocaleDateString("ar-EG"):"-",last_login:e.last_login?new Date(e.last_login).toLocaleDateString("ar-EG"):"لم يسجل دخول"}:{id:"غير معروف",name:"غير معروف",email:"",phone:"-",role:"user",role_name:"غير معروف",is_active:!1,status:"غير نشط",status_color:"red",allowed_warehouses:[],permissions:[],created_at:"-",updated_at:"-",last_login:"لم يسجل دخول"}}getRoleName(e){if(!e||"string"!==typeof e)return"غير معروف";const r={superadmin:"المشرف العام",warehouse_manager:"مدير المخازن",company_manager:"مدير الشركة"};return r[e]||e}getRolePermissions(e){if(!e||"string"!==typeof e)return[];const r={superadmin:["الوصول الكامل إلى جميع المخازن","إدارة المستخدمين والأدوار","إنشاء وتعديل وحذف الأصناف","إدارة الحركات والنقل","تصدير التقارير والبيانات","إعدادات النظام"],warehouse_manager:["الوصول إلى المخازن المحددة فقط","إنشاء وتعديل الأصناف في المخازن المسموحة","إدارة الحركات والنقل بين المخازن المسموحة","عرض التقارير للمخازن المسموحة","تصدير بيانات المخازن المسموحة"],company_manager:["عرض جميع البيانات للقراءة فقط","تصفية البيانات والتقارير","تصدير التقارير والبيانات","لا يمكن التعديل أو الحذف"]};return r[e]||[]}cleanUserData(e){return e&&"object"===typeof e?{name:e.name?e.name.trim():"",email:e.email?e.email.trim().toLowerCase():"",phone:e.phone?e.phone.trim():null,role:e.role||"company_manager",is_active:!1!==e.is_active,allowed_warehouses:Array.isArray(e.allowed_warehouses)?e.allowed_warehouses:[],permissions:Array.isArray(e.permissions)?e.permissions:[]}:{name:"",email:"",role:"company_manager",is_active:!0,allowed_warehouses:[],permissions:[]}}getDefaultPermissionsForRole(e){const r={superadmin:["all"],warehouse_manager:["manage_inventory","create_transfers","dispatch_items","update_items","view_reports","export_data"],company_manager:["view_reports","export_data","view_inventory"]};return r[e]||["view_reports"]}hasPermission(e,r){if(!e||!r)return!1;const t=Array.isArray(e.permissions)?e.permissions:[];return"superadmin"===e.role||(t.includes(r)||t.includes("all")||t.includes("full_access"))}}const i=new n;r.A=i},4432:function(e,r,t){var s=t(5499),a=t(3556),o=t(1032);const n=[{path:"/login",name:"Login",component:()=>t.e(246).then(t.bind(t,2246)),meta:{public:!0,layout:"empty",title:"تسجيل الدخول"}},{path:"/",redirect:"/dashboard"},{path:"/dashboard",name:"Dashboard",component:()=>t.e(358).then(t.bind(t,8358)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"],title:"لوحة التحكم"}},{path:"/warehouses",name:"Warehouses",component:()=>t.e(473).then(t.bind(t,6473)),meta:{requiresAuth:!0,allowedRoles:["superadmin"],title:"إدارة المخازن"}},{path:"/users",name:"Users",component:()=>t.e(260).then(t.bind(t,2260)),meta:{requiresAuth:!0,allowedRoles:["superadmin"],title:"إدارة المستخدمين"}},{path:"/inventory",name:"Inventory",component:()=>Promise.all([t.e(297),t.e(360),t.e(335),t.e(965),t.e(290),t.e(425),t.e(647),t.e(157),t.e(309),t.e(545),t.e(130),t.e(218),t.e(76),t.e(824)]).then(t.bind(t,6824)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"],permissions:{company_manager:"viewer",warehouse_manager:"full_access"},title:"إدارة المخزون"}},{path:"/inventory/add",name:"AddInventory",component:()=>Promise.resolve().then(t.bind(t,8038)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"},title:"إضافة صنف"}},{path:"/inventory/edit/:id",name:"EditInventory",component:()=>Promise.all([t.e(297),t.e(360),t.e(335),t.e(965),t.e(290),t.e(425),t.e(647),t.e(157),t.e(309),t.e(545),t.e(130),t.e(218),t.e(76)]).then(t.bind(t,7802)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"},title:"تعديل الصنف"}},{path:"/transfers",name:"Transfers",component:()=>t.e(287).then(t.bind(t,2287)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"},title:"نقل المخزون"}},{path:"/dispatch",name:"Dispatch",component:()=>t.e(877).then(t.bind(t,2877)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"},title:"صرف خارجي"}},{path:"/transactions",name:"Transactions",component:()=>t.e(253).then(t.bind(t,253)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"],permissions:{company_manager:"viewer",warehouse_manager:"viewer"},title:"سجل الحركات"}},{path:"/reports",name:"Reports",component:()=>t.e(621).then(t.bind(t,3621)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager"],permissions:{company_manager:"viewer",warehouse_manager:"none"},title:"التقارير"}},{path:"/profile",name:"Profile",component:()=>t.e(36).then(t.bind(t,1036)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"],title:"الملف الشخصي"}},{path:"/unauthorized",name:"Unauthorized",component:{template:'\n        <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center px-4">\n          <div class="text-center">\n            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full mb-6">\n              <svg class="w-8 h-8 text-red-600 dark:text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0H9m3-6a3 3 0 110-6 3 3 0 010 6zm2 7a9 9 0 11-18 0 9 9 0 0118 0z"/>\n              </svg>\n            </div>\n            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">صلاحية مرفوضة</h1>\n            <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">\n              ليس لديك الصلاحية للوصول إلى هذه الصفحة\n            </p>\n            <router-link to="/dashboard" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">\n              العودة للرئيسية\n            </router-link>\n          </div>\n        </div>\n      '},meta:{layout:"empty",title:"صلاحية مرفوضة"}},{path:"/:pathMatch(.*)*",name:"NotFound",component:{template:'\n        <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center px-4">\n          <div class="text-center">\n            <h1 class="text-6xl font-bold text-gray-900 dark:text-white mb-4">404</h1>\n            <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">\n              الصفحة غير موجودة\n            </p>\n            <router-link to="/dashboard" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">\n              العودة للرئيسية\n            </router-link>\n          </div>\n        </div>\n      '},meta:{layout:"empty",title:"الصفحة غير موجودة"}}],i=(0,s.aE)({history:(0,s.LA)(),routes:n,scrollBehavior(e,r,t){return t||{top:0}}}),c=(e,r)=>{if(!r.allowedRoles)return!0;if(!r.allowedRoles.includes(e))return!1;if(r.permissions){const t=r.permissions[e];if("none"===t)return!1}return!0};let u=null;let l=!1,d=[];const _=()=>new Promise(e=>{if(l)return void e();const r=(0,o.hg)(a.j2,t=>{l=!0,d.forEach(e=>e()),d=[],r(),e()});setTimeout(()=>{l=!0,e()},2e3)});i.beforeEach(async(e,r,t)=>{console.log("Navigation:",{from:r.path,to:e.path,toName:e.name,requiresAuth:e.meta.requiresAuth}),await _();const s=a.j2.currentUser;if(console.log("Firebase currentUser:",s?"Logged in":"Not logged in"),e.meta.public)return"Login"===e.name&&s?(console.log("Already authenticated, redirecting from login to dashboard"),void t("/dashboard")):void t();if(e.meta.requiresAuth){if(!s)return console.log("Not authenticated, redirecting to login"),void t("/login");if(u){const r=u.state.userProfile,s=r?.role;if(console.log("Store user profile:",{hasProfile:!!r,userRole:s,isActive:r?.is_active}),!1===r?.is_active)return console.log("User account is inactive"),u.dispatch("logout"),void t("/login");if(e.meta.allowedRoles){if(!s)return console.log("User has no role assigned"),void t("/unauthorized");if(!c(s,e.meta))return console.log(`User role ${s} not allowed for route ${e.name}`),void t("/unauthorized")}}else console.warn("Store not available for permission check, allowing navigation");t()}else t()}),i.onError((e,r)=>{console.error("Router navigation error:",e),e.message.includes("Failed to fetch dynamically imported module")&&(console.warn("Chunk loading failed for route:",r.path),window.location.href.includes(r.path)||(window.location.href=r.fullPath))}),window.addEventListener("unhandledrejection",e=>{"ChunkLoadError"===e.reason?.name&&(console.warn("Chunk load error, reloading page..."),window.location.reload())}),r.A=i},5062:function(e,r,t){t.d(r,{Qi:function(){return n},VX:function(){return i},XY:function(){return o},cE:function(){return l},t2:function(){return c}});var s=t(2405),a=t(3556);const o={name:"الاسم",code:"الكود",color:"اللون",cartons_count:"عدد الكراتين",per_carton_count:"عدد في الكرتونة",single_bottles_count:"عدد القزاز الفردي",total_added:"الكميه المضافه",remaining_quantity:"الكميه المتبقيه",warehouse_id:"المخزن",supplier:"المورد",item_location:"مكان الصنف",created_at:"تاريخ الإنشاء",updated_at:"تاريخ التحديث",created_by:"تم الإنشاء بواسطة",updated_by:"تم التحديث بواسطة",notes:"ملاحظات"},n={main_warehouse:"مخزن شارع الشيخ",tera_warehouse:"مخزن الترعه",shobeen_warehouse:"مخزن موقف شبين",hyper_warehouse:"مخزن هايبر التهامي"},i={factory:"صرف الي مصنع البران",zahra:"صرف الي مخزن الزهراء"},c={ADD:"ADD",TRANSFER:"TRANSFER",DISPATCH:"DISPATCH"},u={ITEM_NOT_FOUND:"الصنف غير موجود",WRONG_WAREHOUSE:"الصنف ليس في المخزن المحدد",INSUFFICIENT_QUANTITY:"الكمية المطلوبة غير متوفرة",UNAUTHORIZED:"ليس لديك صلاحية للقيام بهذا الإجراء",NETWORK_ERROR:"خطأ في الاتصال بالشبكة",UNKNOWN_ERROR:"حدث خطأ غير متوقع",INVALID_DATA:"بيانات غير صحيحة"};class l{static async addOrUpdateItem(e,r,t=!0){try{const{warehouse_id:s,code:a,color:o,name:n}=e;if(!s||!a||!o||!n)throw new Error("بيانات غير مكتملة: يرجى التأكد من إدخال جميع الحقول المطلوبة (الاسم، الكود، اللون، المخزن)");if(!r)throw new Error("يجب تسجيل الدخول أولاً");const i=this._cleanItemData(e),c=await this._findExistingItem(i);return c?await this._updateExistingItem(c,i,r,t):await this._createNewItem(i,r)}catch(s){throw console.error("Error in addOrUpdateItem:",s),this._handleError(s)}}static async _findExistingItem(e){try{const r=(0,s.rJ)(a.db,"items");if(!e.warehouse_id||!e.code||!e.color||!e.name)return console.warn("Missing required fields for query:",e),null;const t=(0,s.P)(r,(0,s._M)("warehouse_id","==",e.warehouse_id),(0,s._M)("code","==",e.code.trim()),(0,s._M)("color","==",e.color.trim()),(0,s._M)("name","==",e.name.trim())),o=await(0,s.GG)(t);return o.empty?null:{id:o.docs[0].id,...o.docs[0].data()}}catch(r){return console.error("Error finding existing item:",r),null}}static _cleanItemData(e){const r={...e};if(r.name=r.name?.trim()||"",r.code=r.code?.trim()||"",r.color=r.color?.trim()||"",r.supplier=r.supplier?.trim()||"",r.item_location=r.item_location?.trim()||"",r.notes=r.notes?.trim()||"",!r.name)throw new Error("اسم الصنف مطلوب");if(!r.code)throw new Error("كود الصنف مطلوب");if(!r.color)throw new Error("لون الصنف مطلوب");if(!r.warehouse_id)throw new Error("المخزن مطلوب");if(r.cartons_count=Number(r.cartons_count)||0,r.per_carton_count=Number(r.per_carton_count)||1,r.single_bottles_count=Number(r.single_bottles_count)||0,r.supplier=r.supplier||"",r.item_location=r.item_location||"",r.notes=r.notes||"",r.cartons_count<0)throw new Error("عدد الكراتين لا يمكن أن يكون سالباً");if(r.per_carton_count<1)throw new Error("عدد القطع في الكرتونة يجب أن يكون 1 على الأقل");if(r.single_bottles_count<0)throw new Error("عدد القزاز الفردي لا يمكن أن يكون سالباً");return r}static async _updateExistingItem(e,r,t,o){const n=(0,s.wP)(a.db),i=new Date,u={updated_at:i,updated_by:t};let l=0;if(o){const t=e.cartons_count||0,s=r.cartons_count||0;u.cartons_count=t+s,void 0!==r.per_carton_count&&null!==r.per_carton_count&&r.per_carton_count>=1?u.per_carton_count=r.per_carton_count:u.per_carton_count=e.per_carton_count||1;const a=u.per_carton_count;l=s*a,u.single_bottles_count=e.single_bottles_count||0}else void 0!==r.single_bottles_count&&null!==r.single_bottles_count?(u.single_bottles_count=Math.max(0,r.single_bottles_count),l=r.single_bottles_count):u.single_bottles_count=e.single_bottles_count||0,u.cartons_count=e.cartons_count||0,u.per_carton_count=e.per_carton_count||1;const d=e.total_added||0,_=e.remaining_quantity||0;if(u.total_added=d+l,u.remaining_quantity=_+l,void 0!==r.notes&&(u.notes=r.notes),void 0!==r.supplier&&(u.supplier=r.supplier),void 0!==r.item_location&&(u.item_location=r.item_location),u.remaining_quantity<0)throw new Error("الكمية المتبقية لا يمكن أن تكون سالبة");if(u.total_added<d)throw new Error("الكمية المضافة التراكمية لا يمكن أن تقل");const m=(0,s.H9)(a.db,"items",e.id);n.update(m,u);const h=(0,s.H9)((0,s.rJ)(a.db,"transactions"));return n.set(h,{item_id:e.id,from_warehouse:null,to_warehouse:r.warehouse_id,type:c.ADD,cartons_delta:o&&r.cartons_count||0,single_delta:o?0:r.single_bottles_count||0,per_carton_updated:r.per_carton_count,previous_remaining:_,new_remaining:u.remaining_quantity,timestamp:i,user_id:t,notes:r.notes||(o?"إضافة كراتين للمخزن":"إضافة قزاز فردي للمخزن"),created_at:i}),await n.commit(),{type:"updated",id:e.id,addedQuantity:l}}static async _createNewItem(e,r){const t=(0,s.wP)(a.db),o=new Date,n=e.cartons_count||0,i=e.per_carton_count||1,u=e.single_bottles_count||0,l=n*i+u;if(!e.name||!e.code||!e.color||!e.warehouse_id)throw new Error("جميع الحقول المطلوبة يجب أن تكون مملوءة (الاسم، الكود، اللون، المخزن)");if(l<=0)throw new Error("يجب إدخال كمية صحيحة");const d={name:e.name,code:e.code,color:e.color,warehouse_id:e.warehouse_id,cartons_count:n,per_carton_count:i,single_bottles_count:u,total_added:l,remaining_quantity:l,supplier:e.supplier||"",item_location:e.item_location||"",notes:e.notes||"",created_at:o,created_by:r,updated_at:o,updated_by:r},_=(0,s.H9)((0,s.rJ)(a.db,"items"));t.set(_,d);const m=(0,s.H9)((0,s.rJ)(a.db,"transactions"));return t.set(m,{item_id:_.id,from_warehouse:null,to_warehouse:e.warehouse_id,type:c.ADD,cartons_delta:n,single_delta:u,per_carton_updated:i,previous_remaining:0,new_remaining:l,timestamp:o,user_id:r,notes:e.notes||"إنشاء صنف جديد",created_at:o}),await t.commit(),{type:"created",id:_.id,addedQuantity:l}}static async transferItem(e,r){try{const{item_id:t,from_warehouse:o,to_warehouse:i,cartons:l,single_bottles:d,notes:_}=e;if(!t||!o||!i)throw new Error("بيانات النقل غير مكتملة");if(!r)throw new Error("يجب تسجيل الدخول أولاً");const m=Number(l)||0,h=Number(d)||0;if(m<=0&&h<=0)throw new Error("يجب تحديد كمية للنقل");return await(0,s.c4)(a.db,async e=>{const l=(0,s.H9)(a.db,"items",t),d=await e.get(l);if(!d.exists())throw new Error(u.ITEM_NOT_FOUND);const w=d.data();if(w.warehouse_id!==o)throw new Error(u.WRONG_WAREHOUSE);const p=w.per_carton_count||1,g=m*p+h;if(g>w.remaining_quantity)throw new Error(u.INSUFFICIENT_QUANTITY);const E={remaining_quantity:w.remaining_quantity-g,updated_at:new Date,updated_by:r};m>0&&(E.cartons_count=Math.max(0,(w.cartons_count||0)-m)),h>0&&(E.single_bottles_count=Math.max(0,(w.single_bottles_count||0)-h)),await e.update(l,E),await this._handleDestinationItem(e,w,i,m,h,g,r);const f=(0,s.H9)((0,s.rJ)(a.db,"transactions"));return await e.set(f,{item_id:t,from_warehouse:o,to_warehouse:i,type:c.TRANSFER,cartons_delta:-m,single_delta:-h,per_carton_updated:w.per_carton_count,previous_remaining:w.remaining_quantity,new_remaining:E.remaining_quantity,timestamp:new Date,user_id:r,notes:_||`نقل من ${n[o]} إلى ${n[i]}`,created_at:new Date}),{success:!0,transferQty:g,sourceItemId:t,destinationWarehouse:i}})}catch(t){throw console.error("Error in transferItem:",t),this._handleError(t)}}static async _handleDestinationItem(e,r,t,o,n,i,c){const u=(0,s.rJ)(a.db,"items"),l=(0,s.P)(u,(0,s._M)("warehouse_id","==",t),(0,s._M)("code","==",r.code),(0,s._M)("color","==",r.color),(0,s._M)("name","==",r.name)),d=await(0,s.GG)(l),_=new Date;if(!d.empty&&d.docs.length>0){const r=d.docs[0],t=r.data(),u={total_added:(t.total_added||0)+i,remaining_quantity:(t.remaining_quantity||0)+i,cartons_count:(t.cartons_count||0)+o,single_bottles_count:(t.single_bottles_count||0)+n,updated_at:_,updated_by:c},l=(0,s.H9)(a.db,"items",r.id);await e.update(l,u)}else{const u={name:r.name,code:r.code,color:r.color,warehouse_id:t,cartons_count:o,per_carton_count:r.per_carton_count||1,single_bottles_count:n,total_added:i,remaining_quantity:i,supplier:r.supplier||"",item_location:r.item_location||"",notes:r.notes||"",created_at:_,created_by:c,updated_at:_,updated_by:c},l=(0,s.H9)((0,s.rJ)(a.db,"items"));await e.set(l,u)}}static async dispatchItem(e,r){try{const{item_id:t,from_warehouse:o,to_destination:n,cartons:l,single_bottles:d,notes:_}=e;if(!t||!o||!n)throw new Error("بيانات الصرف غير مكتملة");if(!r)throw new Error("يجب تسجيل الدخول أولاً");const m=Number(l)||0,h=Number(d)||0;if(m<=0&&h<=0)throw new Error("يجب تحديد كمية للصرف");return await(0,s.c4)(a.db,async e=>{const l=(0,s.H9)(a.db,"items",t),d=await e.get(l);if(!d.exists())throw new Error(u.ITEM_NOT_FOUND);const w=d.data();if(w.warehouse_id!==o)throw new Error(u.WRONG_WAREHOUSE);const p=w.per_carton_count||1,g=m*p+h;if(g>w.remaining_quantity)throw new Error(u.INSUFFICIENT_QUANTITY);const E={remaining_quantity:w.remaining_quantity-g,updated_at:new Date,updated_by:r};m>0&&(E.cartons_count=Math.max(0,(w.cartons_count||0)-m)),h>0&&(E.single_bottles_count=Math.max(0,(w.single_bottles_count||0)-h)),await e.update(l,E);const f=(0,s.H9)((0,s.rJ)(a.db,"transactions"));return await e.set(f,{item_id:t,from_warehouse:o,to_warehouse:n,type:c.DISPATCH,cartons_delta:-m,single_delta:-h,per_carton_updated:w.per_carton_count,previous_remaining:w.remaining_quantity,new_remaining:E.remaining_quantity,timestamp:new Date,user_id:r,notes:_||`صرف إلى ${i[n]||n}`,created_at:new Date}),{success:!0,dispatchQty:g,itemId:t,destination:n}})}catch(t){throw console.error("Error in dispatchItem:",t),this._handleError(t)}}static async getLowStockItems(e=null){try{let r=(0,s.rJ)(a.db,"items");r=e?(0,s.P)(r,(0,s._M)("warehouse_id","==",e),(0,s._M)("remaining_quantity","<",10)):(0,s.P)(r,(0,s._M)("remaining_quantity","<",10));const t=await(0,s.GG)(r);return t.docs.map(e=>({id:e.id,...e.data(),_display:{warehouse:n[e.data().warehouse_id]||e.data().warehouse_id}}))}catch(r){throw console.error("Error in getLowStockItems:",r),this._handleError(r)}}static async getRecentTransactions(e=50){try{const r=(0,s.P)((0,s.rJ)(a.db,"transactions"),(0,s.My)("timestamp","desc")),t=await(0,s.GG)(r),o=t.docs.slice(0,e).map(e=>({id:e.id,...e.data()}));return o.map(e=>({...e,_display:{from_warehouse:n[e.from_warehouse]||e.from_warehouse,to_warehouse:n[e.to_warehouse]||i[e.to_warehouse]||e.to_warehouse}}))}catch(r){throw console.error("Error in getRecentTransactions:",r),this._handleError(r)}}static async getWarehouseItems(e){try{if(!e)throw new Error("يجب تحديد المخزن");const r=(0,s.P)((0,s.rJ)(a.db,"items"),(0,s._M)("warehouse_id","==",e),(0,s.My)("name")),t=await(0,s.GG)(r);return t.docs.map(e=>({id:e.id,...e.data(),_display:{warehouse:n[e.data().warehouse_id]||e.data().warehouse_id}}))}catch(r){throw console.error("Error in getWarehouseItems:",r),this._handleError(r)}}static async getAllItems(e=50){try{const r=(0,s.P)((0,s.rJ)(a.db,"items"),(0,s.My)("name")),t=await(0,s.GG)(r),o=t.docs.slice(0,e).map(e=>({id:e.id,...e.data()}));return o.map(e=>({...e,_display:{warehouse:n[e.warehouse_id]||e.warehouse_id}}))}catch(r){throw console.error("Error in getAllItems:",r),this._handleError(r)}}static async searchItems(e,r=null){try{if(!e||e.trim().length<2)throw new Error("يجب إدخال مصطلح بحث مكون من حرفين على الأقل");const t=e.toLowerCase().trim();let s=[];return s=r?await this.getWarehouseItems(r):await this.getAllItems(1e3),s.filter(e=>e.name?.toLowerCase().includes(t)||e.code?.toLowerCase().includes(t)||e.color?.toLowerCase().includes(t)||e.supplier?.toLowerCase().includes(t))}catch(t){throw console.error("Error in searchItems:",t),this._handleError(t)}}static async getItemById(e){try{if(!e)throw new Error("معرف الصنف مطلوب");const r=await(0,s.x7)((0,s.H9)(a.db,"items",e));if(!r.exists())throw new Error(u.ITEM_NOT_FOUND);return{id:r.id,...r.data(),_display:{warehouse:n[r.data().warehouse_id]||r.data().warehouse_id}}}catch(r){throw console.error("Error in getItemById:",r),this._handleError(r)}}static async updateItemDetails(e,r,t){try{if(!e||!t)throw new Error("معرف الصنف ومعرف المستخدم مطلوبان");const o=["supplier","item_location","notes","per_carton_count"],n={};for(const e of o)void 0!==r[e]&&(n[e]=r[e]);if(void 0!==n.per_carton_count&&n.per_carton_count<1)throw new Error("عدد القطع في الكرتونة يجب أن يكون 1 على الأقل");n.updated_at=new Date,n.updated_by=t;const i=(0,s.H9)(a.db,"items",e);return await(0,s.mZ)(i,n),{success:!0,itemId:e}}catch(o){throw console.error("Error in updateItemDetails:",o),this._handleError(o)}}static async getWarehouseStats(e=null){try{let r=(0,s.rJ)(a.db,"items");e&&(r=(0,s.P)(r,(0,s._M)("warehouse_id","==",e)));const t=await(0,s.GG)(r),o=t.docs.map(e=>e.data()),i=o.length,c=o.reduce((e,r)=>e+(r.remaining_quantity||0),0),u=o.filter(e=>(e.remaining_quantity||0)<10).length,l=o.filter(e=>0===(e.remaining_quantity||0)).length;return{totalItems:i,totalQuantity:c,lowStockItems:u,outOfStockItems:l,warehouse:e?n[e]:"جميع المخازن"}}catch(r){throw console.error("Error in getWarehouseStats:",r),this._handleError(r)}}static convertForDisplay(e){return Array.isArray(e)?e.map(e=>this._addDisplayLabels(e)):this._addDisplayLabels(e)}static _addDisplayLabels(e){return e?{...e,_display:{warehouse:n[e.warehouse_id]||e.warehouse_id}}:e}static _handleError(e){if(console.error("Inventory Service Error:",e),e.code)switch(e.code){case"permission-denied":return new Error("ليس لديك صلاحية للقيام بهذا الإجراء");case"unavailable":return new Error("الخدمة غير متاحة حالياً. يرجى المحاولة لاحقاً");case"resource-exhausted":return new Error("تم تجاوز الحد المسموح. يرجى المحاولة لاحقاً");case"failed-precondition":return new Error("البيانات غير صالحة للعملية المطلوبة");case"invalid-argument":return new Error("بيانات غير صحيحة");default:return new Error(e.message||u.UNKNOWN_ERROR)}return e.message&&e.message.includes(" ")?e:new Error(e.message||u.UNKNOWN_ERROR)}static calculateTotalQuantity(e,r,t){const s=(Number(e)||0)*(Number(r)||1),a=Number(t)||0;return s+a}static validateItemData(e,r="create"){const t=[];if(e.name?.trim()||t.push("الاسم مطلوب"),e.code?.trim()||t.push("الكود مطلوب"),e.color?.trim()||t.push("اللون مطلوب"),e.warehouse_id||t.push("المخزن مطلوب"),"create"===r){const r=this.calculateTotalQuantity(e.cartons_count,e.per_carton_count,e.single_bottles_count);r<=0&&t.push("يجب إدخال كمية صحيحة")}if(t.length>0)throw new Error(t.join("، "));return!0}}},7518:function(e,r,t){var s=t(834),a=t(3556),o=t(1032),n=t(2405),i=t(5062),c=t(203);const u={arabicToEnglish:{"الاسم":"name","الكود":"code","اللون":"color","المخزن_id":"warehouse_id","المخزن":"warehouse_id","عدد_الكراتين":"cartons_count","عدد_في_الكرتونه":"per_carton_count","عدد_القزاز_الفردي":"single_bottles_count","الكميه_المضافه":"total_added","الكميه_المتبقيه":"remaining_quantity","المورد":"supplier","مكان_الصنف":"item_location"},englishToArabic:i.XY};function l(e){const r={"auth/invalid-email":"البريد الإلكتروني غير صحيح","auth/user-disabled":"هذا الحساب معطل","auth/user-not-found":"لا يوجد حساب بهذا البريد الإلكتروني","auth/wrong-password":"كلمة المرور غير صحيحة","auth/email-already-in-use":"هذا البريد الإلكتروني مستخدم بالفعل","auth/weak-password":"كلمة المرور ضعيفة","auth/network-request-failed":"خطأ في الاتصال بالشبكة","auth/too-many-requests":"محاولات تسجيل دخول كثيرة. يرجى المحاولة لاحقاً","auth/configuration-not-found":"خطأ في إعدادات النظام"};return r[e]||"حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى"}r.A=(0,s.y$)({state:{user:null,userProfile:null,loading:!1,warehouses:[],warehousesLoaded:!1,inventory:[],transactions:[],itemHistory:[],filters:{warehouse:"",search:""},authError:null,operationLoading:!1,operationError:null,fieldMappings:u,notifications:[],unsubscribeInventory:null,unsubscribeTransactions:null,unsubscribeWarehouses:null,recentTransactions:[],recentTransactionsLoading:!1,requiresCompositeIndex:!1,allUsers:[],usersLoading:!1},mutations:{SET_USER(e,r){e.user=r},SET_USER_PROFILE(e,r){e.userProfile=r},SET_LOADING(e,r){e.loading=r},SET_OPERATION_LOADING(e,r){e.operationLoading=r},SET_OPERATION_ERROR(e,r){e.operationError=r},SET_WAREHOUSES(e,r){e.warehouses=r},SET_WAREHOUSES_LOADED(e,r){e.warehousesLoaded=r},SET_INVENTORY(e,r){e.inventory=r},SET_TRANSACTIONS(e,r){e.transactions=r},SET_ITEM_HISTORY(e,r){e.itemHistory=r},SET_FILTERS(e,r){e.filters={...e.filters,...r}},ADD_ITEM(e,r){e.inventory.push(r)},UPDATE_ITEM(e,r){const t=e.inventory.findIndex(e=>e.id===r.id);-1!==t&&e.inventory.splice(t,1,r)},REMOVE_ITEM(e,r){e.inventory=e.inventory.filter(e=>e.id!==r)},SET_AUTH_ERROR(e,r){e.authError=r},CLEAR_OPERATION_ERROR(e){e.operationError=null},ADD_NOTIFICATION(e,r){r.id=Date.now().toString(),r.timestamp=new Date,e.notifications.push(r),setTimeout(()=>{const t=e.notifications.findIndex(e=>e.id===r.id);-1!==t&&e.notifications.splice(t,1)},5e3)},REMOVE_NOTIFICATION(e,r){e.notifications=e.notifications.filter(e=>e.id!==r)},CLEAR_NOTIFICATIONS(e){e.notifications=[]},SET_UNSUBSCRIBE_INVENTORY(e,r){e.unsubscribeInventory&&e.unsubscribeInventory(),e.unsubscribeInventory=r},SET_UNSUBSCRIBE_TRANSACTIONS(e,r){e.unsubscribeTransactions&&e.unsubscribeTransactions(),e.unsubscribeTransactions=r},SET_UNSUBSCRIBE_WAREHOUSES(e,r){e.unsubscribeWarehouses&&e.unsubscribeWarehouses(),e.unsubscribeWarehouses=r},CLEAR_UNSUBSCRIBERS(e){e.unsubscribeInventory&&(e.unsubscribeInventory(),e.unsubscribeInventory=null),e.unsubscribeTransactions&&(e.unsubscribeTransactions(),e.unsubscribeTransactions=null),e.unsubscribeWarehouses&&(e.unsubscribeWarehouses(),e.unsubscribeWarehouses=null)},SET_RECENT_TRANSACTIONS(e,r){e.recentTransactions=r},SET_RECENT_TRANSACTIONS_LOADING(e,r){e.recentTransactionsLoading=r},ADD_RECENT_TRANSACTION(e,r){e.recentTransactions.unshift(r),e.recentTransactions.length>50&&(e.recentTransactions=e.recentTransactions.slice(0,50))},SET_REQUIRES_COMPOSITE_INDEX(e,r){e.requiresCompositeIndex=r},SET_ALL_USERS(e,r){e.allUsers=r},SET_USERS_LOADING(e,r){e.usersLoading=r}},actions:{showNotification({commit:e,getters:r},t){if(!t||!t.message)return void console.warn("Invalid notification:",t);const s={type:"info",title:"",message:"",duration:5e3},a={...s,...t};e("ADD_NOTIFICATION",a),"error"===a.type&&console.error("Notification Error:",a.message)},async initializeAuth({commit:e,dispatch:r}){return new Promise(t=>{(0,o.hg)(a.j2,async s=>{if(s){e("SET_USER",s);try{await r("loadUserProfile",s)}catch(a){console.error("Error in auth initialization:",a),e("SET_AUTH_ERROR","فشل في تحميل بيانات المستخدم")}}else e("SET_USER",null),e("SET_USER_PROFILE",null),e("SET_INVENTORY",[]),e("SET_TRANSACTIONS",[]),e("SET_ITEM_HISTORY",[]),e("SET_RECENT_TRANSACTIONS",[]),e("SET_WAREHOUSES_LOADED",!1),e("SET_REQUIRES_COMPOSITE_INDEX",!1),e("CLEAR_UNSUBSCRIBERS");t()})})},async loadUserProfile({commit:e,dispatch:r},t){try{console.log("Loading user profile for:",t.email);const s=await(0,n.x7)((0,n.H9)(a.db,"users",t.uid));if(!s.exists()){console.error("User profile not found in Firestore:",t.email);const s={email:t.email,name:t.email.split("@")[0],role:"pending",allowed_warehouses:[],permissions:["view_reports"],is_active:!1,profile_complete:!1,needs_approval:!0,created_at:new Date};return await(0,n.BN)((0,n.H9)(a.db,"users",t.uid),s),e("SET_USER_PROFILE",s),r("showNotification",{type:"warning",message:"حسابك قيد المراجعة. يرجى الانتظار حتى يتم تفعيله من قبل المشرف."}),void await r("notifyAdminAboutPendingUser",{userId:t.uid,userEmail:t.email})}const o=s.data();if(console.log("Loaded user profile:",o),!1===o.is_active)return r("showNotification",{type:"error",message:"حسابك غير نشط. يرجى التواصل مع المشرف."}),void await r("logout");e("SET_USER_PROFILE",o),console.log("User profile loaded with role:",o.role,"permissions:",o.permissions),r("showNotification",{type:"success",message:`مرحباً ${o.name}! تم تسجيل الدخول بنجاح.`}),await r("loadWarehouses"),r("subscribeToInventory"),r("subscribeToTransactions"),r("getRecentTransactions")}catch(s){console.error("Error loading user profile:",s),r("showNotification",{type:"error",message:"حدث خطأ في تحميل بيانات المستخدم"}),await r("logout")}},async notifyAdminAboutPendingUser({dispatch:e},{userId:r,userEmail:t}){try{const e=(0,n.H9)((0,n.rJ)(a.db,"admin_notifications"));await(0,n.BN)(e,{type:"new_user_pending",user_id:r,user_email:t,timestamp:new Date,message:"مستخدم جديد يحتاج إلى التفعيل",read:!1}),console.log("Admin notified about pending user:",t)}catch(s){console.error("Error notifying admin:",s)}},async login({commit:e,dispatch:r},{email:t,password:s}){e("SET_LOADING",!0),e("SET_AUTH_ERROR",null);try{console.log("Attempting login with:",t);const n=await(0,o.x9)(a.j2,t,s),i=n.user;return console.log("Login successful, user:",i.uid),await r("loadUserProfile",i),e("SET_USER",i),i}catch(n){console.error("Login error details:",n);const t=l(n.code);throw e("SET_AUTH_ERROR",t),r("showNotification",{type:"error",message:t}),new Error(t)}finally{e("SET_LOADING",!1)}},async logout({commit:e,dispatch:r}){try{await(0,o.CI)(a.j2),e("SET_USER",null),e("SET_USER_PROFILE",null),e("SET_INVENTORY",[]),e("SET_TRANSACTIONS",[]),e("SET_ITEM_HISTORY",[]),e("SET_RECENT_TRANSACTIONS",[]),e("SET_AUTH_ERROR",null),e("SET_OPERATION_ERROR",null),e("SET_WAREHOUSES_LOADED",!1),e("SET_REQUIRES_COMPOSITE_INDEX",!1),e("CLEAR_UNSUBSCRIBERS"),r("showNotification",{type:"info",message:"تم تسجيل الخروج بنجاح"})}catch(t){throw console.error("Logout error:",t),r("showNotification",{type:"error",message:"خطأ في تسجيل الخروج"}),t}},async loadAllUsers({commit:e,dispatch:r,getters:t}){e("SET_USERS_LOADING",!0);try{if(!t.canManageUsers)throw new Error("ليس لديك صلاحية لعرض المستخدمين");const r=await c.A.getUsers();if(r.success)return e("SET_ALL_USERS",r.data),r.data;throw new Error(r.error||"فشل في تحميل المستخدمين")}catch(s){throw console.error("Error loading users:",s),r("showNotification",{type:"error",message:s.message||"حدث خطأ في تحميل المستخدمين"}),s}finally{e("SET_USERS_LOADING",!1)}},async createUser({commit:e,dispatch:r,getters:t},s){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(console.log("Store.createUser called with:",s),!t.canManageUsers)throw new Error("ليس لديك صلاحية لإضافة مستخدمين");const e=await c.A.createUser(s);if(console.log("UserService.createUser result:",e),e.success)return r("showNotification",{type:"success",message:e.message||`تم إضافة المستخدم "${s.name}" بنجاح`}),{success:!0,data:e.data,message:e.message};throw new Error(e.error||"فشل في إنشاء المستخدم")}catch(a){return console.error("Error creating user:",a),e("SET_OPERATION_ERROR",a.message),r("showNotification",{type:"error",message:a.message||"حدث خطأ في إضافة المستخدم"}),{success:!1,error:a.message}}finally{e("SET_OPERATION_LOADING",!1)}},async updateUser({commit:e,dispatch:r,getters:t},{userId:s,userData:a}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(console.log("Store.updateUser called for:",s,"with:",a),!t.canManageUsers)throw new Error("ليس لديك صلاحية لتحديث المستخدمين");const o=await c.A.updateUser(s,a);if(console.log("UserService.updateUser result:",o),o.success){if(s===t.user?.uid){const r={...t.userProfile,...a};e("SET_USER_PROFILE",r)}return r("showNotification",{type:"success",message:o.message||"تم تحديث المستخدم بنجاح"}),{success:!0,data:o.data,message:o.message}}throw new Error(o.error||"فشل في تحديث المستخدم")}catch(o){return console.error("Error updating user:",o),e("SET_OPERATION_ERROR",o.message),r("showNotification",{type:"error",message:o.message||"حدث خطأ في تحديث المستخدم"}),{success:!1,error:o.message}}finally{e("SET_OPERATION_LOADING",!1)}},async deleteUser({commit:e,dispatch:r,getters:t},s){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!t.canManageUsers)throw new Error("ليس لديك صلاحية لحذف المستخدمين");const e=await c.A.deleteUser(s);if(e.success)return r("showNotification",{type:"success",message:e.message||"تم حذف المستخدم بنجاح"}),{success:!0,message:e.message};throw new Error(e.error||"فشل في حذف المستخدم")}catch(a){return console.error("Error deleting user:",a),e("SET_OPERATION_ERROR",a.message),r("showNotification",{type:"error",message:a.message||"حدث خطأ في حذف المستخدم"}),{success:!1,error:a.message}}finally{e("SET_OPERATION_LOADING",!1)}},async updateUserStatus({commit:e,dispatch:r,getters:t},{userId:s,isActive:a}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!t.canManageUsers)throw new Error("ليس لديك صلاحية لتغيير حالة المستخدمين");const e=await c.A.updateUserStatus(s,a);if(e.success)return r("showNotification",{type:"success",message:e.message||`تم ${a?"تفعيل":"تعطيل"} المستخدم بنجاح`}),{success:!0,message:e.message};throw new Error(e.error||"فشل في تغيير حالة المستخدم")}catch(o){return console.error("Error updating user status:",o),e("SET_OPERATION_ERROR",o.message),r("showNotification",{type:"error",message:o.message||"حدث خطأ في تغيير حالة المستخدم"}),{success:!1,error:o.message}}finally{e("SET_OPERATION_LOADING",!1)}},async getUserStats({commit:e,dispatch:r,getters:t}){try{if(!t.canManageUsers)throw new Error("ليس لديك صلاحية لعرض إحصائيات المستخدمين");const e=await c.A.getUserStats();if(e.success)return e.data;throw new Error(e.error||"فشل في تحميل إحصائيات المستخدمين")}catch(s){throw console.error("Error loading user stats:",s),r("showNotification",{type:"error",message:s.message||"حدث خطأ في تحميل إحصائيات المستخدمين"}),s}},async loadWarehouses({commit:e,dispatch:r,state:t}){try{if(t.warehousesLoaded)return void console.log("Warehouses already loaded, skipping...");console.log("Loading warehouses from Firestore..."),await r("initializeDefaultWarehouses"),await r("subscribeToWarehouses"),e("SET_WAREHOUSES_LOADED",!0),console.log("Warehouses loaded successfully")}catch(s){console.error("Error loading warehouses:",s),r("showNotification",{type:"error",message:"خطأ في تحميل المخازن"}),e("SET_WAREHOUSES_LOADED",!1)}},async subscribeToWarehouses({commit:e,state:r,dispatch:t}){if(r.unsubscribeWarehouses&&r.unsubscribeWarehouses(),r.userProfile){console.log("Subscribing to warehouses...");try{const r=(0,n.P)((0,n.rJ)(a.db,"warehouses"),(0,n.My)("name_ar")),s=(0,n.aQ)(r,r=>{console.log("Warehouses snapshot received:",r.size,"warehouses");const t=r.docs.map(e=>({id:e.id,...e.data()}));console.log("Warehouses loaded:",t.length),e("SET_WAREHOUSES",t)},e=>{console.error("Error in warehouses subscription:",e),t("showNotification",{type:"error",message:"خطأ في تحديث بيانات المخازن"})});e("SET_UNSUBSCRIBE_WAREHOUSES",s)}catch(s){console.error("Error setting up warehouses subscription:",s),t("showNotification",{type:"error",message:"خطأ في إعداد اشتراك المخازن"})}}else console.log("Cannot subscribe to warehouses: User not authenticated")},async initializeDefaultWarehouses({commit:e,dispatch:r}){try{console.log("Checking/initializing default warehouses...");const e=[{id:"main_warehouse",name_ar:"مخزن شارع الشيخ",name_en:"Main Warehouse",type:"primary",is_main:!0,status:"active",capacity:1e3,location:"شارع الشيخ، المنوفية",created_at:new Date,updated_at:new Date},{id:"tera_warehouse",name_ar:"مخزن الترعه",name_en:"Teraa Warehouse",type:"primary",status:"active",capacity:800,location:"الترعة، المنوفية",created_at:new Date,updated_at:new Date},{id:"shobeen_warehouse",name_ar:"مخزن موقف شبين",name_en:"Shobeen Warehouse",type:"primary",status:"active",capacity:600,location:"موقف شبين، المنوفية",created_at:new Date,updated_at:new Date},{id:"hyper_warehouse",name_ar:"مخزن هايبر التهامي",name_en:"Hyper El Tahamy Warehouse",type:"primary",status:"active",capacity:500,location:"هايبر التهامي، المنوفية",created_at:new Date,updated_at:new Date},{id:"matbaa_warehouse",name_ar:"مخزن المطبعه",name_en:"Matbaa Warehouse",type:"primary",status:"active",capacity:400,location:"المطبعة، المنوفية",created_at:new Date,updated_at:new Date},{id:"ghabashi_warehouse",name_ar:"مخزن الغباشي",name_en:"Ghabashi Warehouse",type:"primary",status:"active",capacity:300,location:"الغباشي، المنوفية",created_at:new Date,updated_at:new Date},{id:"factory",name_ar:"صرف الي مصنع البران",name_en:"Al Bran Factory Dispatch",type:"dispatch",status:"active",description:"مصنع البران للتصنيع",created_at:new Date,updated_at:new Date},{id:"zahra",name_ar:"صرف الي مخزن الزهراء",name_en:"Al Zahra Warehouse Dispatch",type:"dispatch",status:"active",description:"مخزن الزهراء للتوزيع",created_at:new Date,updated_at:new Date}],t=(0,n.wP)(a.db);let s=!1;for(const r of e){const e=(0,n.H9)(a.db,"warehouses",r.id),o=await(0,n.x7)(e);o.exists()||(s=!0,t.set(e,r),console.log(`Adding warehouse: ${r.name_ar}`))}s?(await t.commit(),console.log("Default warehouses initialized successfully"),r("showNotification",{type:"success",message:"تم تهيئة المخازن الافتراضية"})):console.log("Warehouses already exist, skipping initialization")}catch(t){throw console.error("Error initializing default warehouses:",t),r("showNotification",{type:"error",message:"خطأ في تهيئة المخازن الافتراضية"}),t}},async subscribeToInventory({commit:e,state:r,dispatch:t}){if(r.unsubscribeInventory&&r.unsubscribeInventory(),r.userProfile){console.log("Subscribing to inventory for user role:",r.userProfile.role),console.log("Allowed warehouses:",r.userProfile.allowed_warehouses);try{let o;const c=(0,n.rJ)(a.db,"items");if("superadmin"===r.userProfile.role)o=(0,n.P)(c,(0,n.My)("warehouse_id"),(0,n.My)("name"));else if("company_manager"===r.userProfile.role||"user"===r.userProfile.role)o=(0,n.P)(c,(0,n.My)("warehouse_id"),(0,n.My)("name"));else{if("warehouse_manager"!==r.userProfile.role)return console.log("User role not authorized for inventory access"),void e("SET_INVENTORY",[]);{const t=r.userProfile.allowed_warehouses||[];if(0===t.length)return console.log("No warehouses assigned to this warehouse manager"),void e("SET_INVENTORY",[]);if(t.includes("all"))o=(0,n.P)(c,(0,n.My)("warehouse_id"),(0,n.My)("name"));else if(t.length<=10)try{o=(0,n.P)(c,(0,n._M)("warehouse_id","in",t),(0,n.My)("warehouse_id"),(0,n.My)("name"))}catch(s){if("failed-precondition"!==s.code)throw s;console.warn("Composite index required. Using client-side filtering."),e("SET_REQUIRES_COMPOSITE_INDEX",!0),o=(0,n.P)(c,(0,n.My)("warehouse_id"),(0,n.My)("name"))}else console.log("More than 10 warehouses - using client-side filtering"),o=(0,n.P)(c,(0,n.My)("warehouse_id"),(0,n.My)("name"))}}const u=(0,n.aQ)(o,t=>{console.log("Inventory snapshot received:",t.size,"items");const s=t.docs.map(e=>{const r=e.data();return i.cE.convertForDisplay({id:e.id,...r})});let a=s;if("warehouse_manager"===r.userProfile.role){const e=r.userProfile.allowed_warehouses||[];e.length>0&&!e.includes("all")&&(e.length>10||r.requiresCompositeIndex)&&(a=s.filter(r=>e.includes(r.warehouse_id)))}console.log("Inventory loaded:",a.length,"items"),e("SET_INVENTORY",a)},r=>{console.error("Error in inventory subscription:",r),"failed-precondition"===r.code?(e("SET_REQUIRES_COMPOSITE_INDEX",!0),t("showNotification",{type:"warning",title:"تحذير الفهرس",message:"يجب إنشاء فهرس مركب لتحسين الأداء. راجع وحدة التحكم في Firebase."})):"permission-denied"===r.code?t("showNotification",{type:"error",message:"ليس لديك صلاحية لعرض المخزون"}):t("showNotification",{type:"error",message:"خطأ في تحميل المخزون"}),e("SET_INVENTORY",[])});e("SET_UNSUBSCRIBE_INVENTORY",u)}catch(s){console.error("Error setting up inventory subscription:",s),t("showNotification",{type:"error",message:"خطأ في إعداد اشتراك المخزون"}),e("SET_INVENTORY",[])}}else console.log("Cannot subscribe to inventory: User not authenticated")},async subscribeToTransactions({commit:e,state:r,dispatch:t}){if(r.unsubscribeTransactions&&r.unsubscribeTransactions(),r.userProfile){console.log("Subscribing to transactions...");try{const r=(0,n.P)((0,n.rJ)(a.db,"transactions"),(0,n.My)("timestamp","desc")),s=(0,n.aQ)(r,r=>{console.log("Transactions snapshot received:",r.size,"transactions");const t=r.docs.map(e=>{const r=e.data();return{id:e.id,...r,_display:{from_warehouse:i.Qi[r.from_warehouse]||r.from_warehouse,to_warehouse:i.Qi[r.to_warehouse]||i.VX[r.to_warehouse]||r.to_warehouse}}});console.log("Transactions loaded:",t.length,"transactions"),e("SET_TRANSACTIONS",t)},r=>{console.error("Error in transactions subscription:",r),t("showNotification",{type:"error",message:"خطأ في تحميل الحركات"}),e("SET_TRANSACTIONS",[])});e("SET_UNSUBSCRIBE_TRANSACTIONS",s)}catch(s){console.error("Error setting up transactions subscription:",s),e("SET_TRANSACTIONS",[])}}else console.log("Cannot subscribe to transactions: User not authenticated")},async getRecentTransactions({commit:e,dispatch:r,state:t}){e("SET_RECENT_TRANSACTIONS_LOADING",!0);try{if(!t.userProfile)return console.log("Cannot load recent transactions: User not authenticated"),[];console.log("Loading recent transactions...");const r=new Date(Date.now()-864e5),s=(0,n.P)((0,n.rJ)(a.db,"transactions"),(0,n._M)("timestamp",">=",r),(0,n.My)("timestamp","desc"),(0,n.AB)(20)),o=await(0,n.GG)(s),c=o.docs.map(e=>{const r=e.data();return{id:e.id,...r,_display:{from_warehouse:i.Qi[r.from_warehouse]||r.from_warehouse,to_warehouse:i.Qi[r.to_warehouse]||i.VX[r.to_warehouse]||r.to_warehouse}}});return console.log("Recent transactions loaded:",c.length),e("SET_RECENT_TRANSACTIONS",c),c}catch(s){return console.error("Error loading recent transactions:",s),r("showNotification",{type:"error",message:"خطأ في تحميل الحركات الحديثة"}),[]}finally{e("SET_RECENT_TRANSACTIONS_LOADING",!1)}},async addInventoryItem({commit:e,dispatch:r,state:t},{itemData:s,isAddingCartons:a=!0}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!t.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!["superadmin","warehouse_manager"].includes(t.userProfile.role))throw new Error("ليس لديك صلاحية لإضافة أصناف");if(!t.user?.uid)throw new Error("معرف المستخدم غير متوفر");if(!s.name?.trim()||!s.code?.trim()||!s.color?.trim()||!s.warehouse_id)throw new Error("جميع الحقول المطلوبة يجب أن تكون مملوءة (الاسم، الكود، اللون، المخزن)");if("warehouse_manager"===t.userProfile.role){const e=t.userProfile.allowed_warehouses||[];if(!e.includes(s.warehouse_id))throw new Error("ليس لديك صلاحية لإضافة أصناف في هذا المخزن")}const o=i.cE.calculateTotalQuantity(s.cartons_count,s.per_carton_count,s.single_bottles_count);if(o<=0)throw new Error("يجب إدخال كمية صحيحة");const n={name:s.name.trim(),code:s.code.trim(),color:s.color.trim(),warehouse_id:s.warehouse_id,cartons_count:Number(s.cartons_count)||0,per_carton_count:Number(s.per_carton_count)||12,single_bottles_count:Number(s.single_bottles_count)||0,supplier:s.supplier?.trim()||"",item_location:s.item_location?.trim()||"",notes:s.notes?.trim()||""};console.log("Adding item with cleaned data:",n);const c=await i.cE.addOrUpdateItem(n,t.user.uid,a);return console.log(`Item ${c.type} successfully:`,c.id),e("ADD_RECENT_TRANSACTION",{type:i.t2.ADD,item_id:c.id,timestamp:new Date,notes:n.notes||"عملية إضافة"}),r("showNotification",{type:"success",message:`تم ${"created"===c.type?"إضافة":"تحديث"} الصنف "${n.name}" بنجاح`}),c}catch(o){console.error("Error adding inventory item:",o);const t=o.message||"حدث خطأ غير متوقع أثناء إضافة الصنف";throw e("SET_OPERATION_ERROR",t),r("showNotification",{type:"error",message:t}),o}finally{e("SET_OPERATION_LOADING",!1)}},async transferItem({commit:e,dispatch:r,state:t},s){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!t.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!["superadmin","warehouse_manager"].includes(t.userProfile.role))throw new Error("ليس لديك صلاحية لنقل الأصناف");if(!t.user?.uid)throw new Error("معرف المستخدم غير متوفر");if("warehouse_manager"===t.userProfile.role){const e=t.userProfile.allowed_warehouses||[];if(!e.includes(s.from_warehouse_id))throw new Error("ليس لديك صلاحية للنقل من هذا المخزن")}const a=await i.cE.transferItem(s,t.user.uid);return console.log("Transfer completed successfully:",a.transferQty),e("ADD_RECENT_TRANSACTION",{type:i.t2.TRANSFER,item_id:s.itemId,timestamp:new Date,notes:"نقل بين المخازن"}),r("showNotification",{type:"success",message:"تم نقل الصنف بنجاح"}),a}catch(a){throw console.error("Error transferring item:",a),e("SET_OPERATION_ERROR",a.message),r("showNotification",{type:"error",message:a.message||"حدث خطأ أثناء نقل الصنف"}),a}finally{e("SET_OPERATION_LOADING",!1)}},async dispatchItem({commit:e,dispatch:r,state:t},s){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!t.userProfile)throw new Error("يجب تسجيل الدخول أولاً");const a="superadmin"===t.userProfile.role||"warehouse_manager"===t.userProfile.role&&t.userProfile.permissions?.includes("dispatch_items");if(!a)throw new Error("ليس لديك صلاحية لصرف الأصناف");if(!t.user?.uid)throw new Error("معرف المستخدم غير متوفر");if("warehouse_manager"===t.userProfile.role){const e=t.userProfile.allowed_warehouses||[];if(!e.includes(s.from_warehouse_id))throw new Error("ليس لديك صلاحية للصرف من هذا المخزن")}const o=await i.cE.dispatchItem(s,t.user.uid);return console.log("Dispatch completed successfully:",o.dispatchQty),e("ADD_RECENT_TRANSACTION",{type:i.t2.DISPATCH,item_id:s.itemId,timestamp:new Date,notes:"صرف إلى خارجي"}),r("showNotification",{type:"success",message:"تم صرف الصنف بنجاح"}),o}catch(a){throw console.error("Error dispatching item:",a),e("SET_OPERATION_ERROR",a.message),r("showNotification",{type:"error",message:a.message||"حدث خطأ أثناء صرف الصنف"}),a}finally{e("SET_OPERATION_LOADING",!1)}},updateFilters({commit:e},r){e("SET_FILTERS",r)},removeNotification({commit:e},r){e("REMOVE_NOTIFICATION",r)},clearNotifications({commit:e}){e("CLEAR_NOTIFICATIONS")},clearOperationError({commit:e}){e("CLEAR_OPERATION_ERROR")}},getters:{isAuthenticated:e=>!!e.user,userRole:e=>e.userProfile?.role,userName:e=>e.userProfile?.name||e.userProfile?.email?.split("@")[0],allowedWarehouses:e=>e.userProfile?.allowed_warehouses||[],userPermissions:e=>e.userProfile?.permissions||[],authError:e=>e.authError,operationError:e=>e.operationError,operationLoading:e=>e.operationLoading,fieldMappings:e=>e.fieldMappings,warehousesLoaded:e=>e.warehousesLoaded,notifications:e=>e.notifications,recentTransactions:e=>e.recentTransactions,recentTransactionsLoading:e=>e.recentTransactionsLoading,requiresCompositeIndex:e=>e.requiresCompositeIndex,allUsers:e=>e.allUsers,usersLoading:e=>e.usersLoading,canEdit:(e,r)=>["superadmin","warehouse_manager"].includes(r.userRole),canDelete:(e,r)=>"superadmin"===r.userRole||"warehouse_manager"===r.userRole&&(r.userPermissions.includes("full_access")||r.userPermissions.includes("delete_items")),canManageUsers:e=>"superadmin"===e.userProfile?.role,canManageWarehouses:e=>"superadmin"===e.userProfile?.role,canDispatch:(e,r)=>"superadmin"===r.userRole||"warehouse_manager"===r.userRole&&r.userPermissions.includes("dispatch_items"),mainWarehouse:e=>e.warehouses.find(e=>e.is_main),primaryWarehouses:e=>e.warehouses.filter(e=>"primary"===e.type),dispatchWarehouses:e=>e.warehouses.filter(e=>"dispatch"===e.type),accessibleWarehouses:(e,r)=>{if(!e.warehousesLoaded)return[];if("superadmin"===r.userRole)return e.warehouses;if("warehouse_manager"===r.userRole){const t=r.allowedWarehouses;if(t&&t.length>0){const r=e.warehouses.filter(e=>"primary"===e.type&&t.includes(e.id)),s=e.warehouses.filter(e=>"dispatch"===e.type);return[...r,...s]}}return"company_manager"===r.userRole?e.warehouses:[]},accessiblePrimaryWarehouses:(e,r)=>{const t=r.accessibleWarehouses;return t.filter(e=>"primary"===e.type)},accessibleDispatchWarehouses:(e,r)=>{const t=r.accessibleWarehouses;return t.filter(e=>"dispatch"===e.type)},dispatchFromWarehouses:(e,r)=>{if(!e.warehousesLoaded)return[];if("superadmin"===r.userRole)return e.warehouses.filter(e=>"primary"===e.type);if("warehouse_manager"===r.userRole){const t=r.allowedWarehouses;if(t&&t.length>0)return e.warehouses.filter(e=>"primary"===e.type&&t.includes(e.id))}return[]},filteredInventory:e=>{let r=e.inventory;if("warehouse_manager"===e.userProfile?.role||"company_manager"===e.userProfile?.role){const t=e.userProfile.allowed_warehouses||[];t.length>0&&(r=r.filter(e=>t.includes(e.warehouse_id)))}if(e.filters.search){const t=e.filters.search.toLowerCase();r=r.filter(e=>e.name?.toLowerCase().includes(t)||e.code?.toLowerCase().includes(t)||e.color?.toLowerCase().includes(t)||e.supplier?.toLowerCase().includes(t)||e.item_location?.toLowerCase().includes(t))}return e.filters.warehouse&&(r=r.filter(r=>r.warehouse_id===e.filters.warehouse)),r},dashboardStats:e=>{let r=e.inventory;if("warehouse_manager"===e.userProfile?.role||"company_manager"===e.userProfile?.role){const t=e.userProfile.allowed_warehouses||[];t.length>0&&(r=r.filter(e=>t.includes(e.warehouse_id)))}const t=r.length,s=r.reduce((e,r)=>e+(r.remaining_quantity||0),0),a=r.filter(e=>(e.remaining_quantity||0)<10).length,o=r.filter(e=>0===(e.remaining_quantity||0)).length,n=50,c=s*n,u=e.recentTransactions.length,l=e.recentTransactions.filter(e=>e.type===i.t2.ADD).length,d=e.recentTransactions.filter(e=>e.type===i.t2.TRANSFER).length,_=e.recentTransactions.filter(e=>e.type===i.t2.DISPATCH).length;return{totalItems:t,totalQuantity:s,lowStockItems:a,outOfStockItems:o,estimatedValue:c,recentTransactions:u,addTransactions:l,transferTransactions:d,dispatchTransactions:_,transactionsByType:{add:l,transfer:d,dispatch:_}}},getArabicLabel:e=>r=>e.fieldMappings.englishToArabic[r]||r,getWarehouseLabel:e=>r=>{if(!r)return"";const t=e.warehouses.find(e=>e.id===r);return t?t.name_ar:r},getDestinationLabel:()=>e=>i.VX[e]||e,getWarehouseById:e=>r=>e.warehouses.find(e=>e.id===r)}})}},function(e){var r=function(r){return e(e.s=r)};e.O(0,[297,360,335,965,290,425,647,157,309,545,130,218,849,980,375,101],function(){return r(8803)});e.O()}]);