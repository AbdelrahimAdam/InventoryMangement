(function(){"use strict";var e={62:function(e,r,t){t.d(r,{Qi:function(){return s},VX:function(){return i},XY:function(){return n},cE:function(){return l},t2:function(){return c}});var o=t(884),a=t(556);const n={name:"الاسم",code:"الكود",color:"اللون",cartons_count:"عدد الكراتين",per_carton_count:"عدد في الكرتونة",single_bottles_count:"عدد القزاز الفردي",total_added:"الكميه المضافه",remaining_quantity:"الكميه المتبقيه",warehouse_id:"المخزن",supplier:"المورد",item_location:"مكان الصنف",created_at:"تاريخ الإنشاء",updated_at:"تاريخ التحديث",created_by:"تم الإنشاء بواسطة",updated_by:"تم التحديث بواسطة",notes:"ملاحظات"},s={main_warehouse:"مخزن شارع الشيخ",tera_warehouse:"مخزن الترعه",shobeen_warehouse:"مخزن موقف شبين",hyper_warehouse:"مخزن هايبر التهامي"},i={factory:"صرف الي مصنع البران",zahra:"صرف الي مخزن الزهراء"},c={ADD:"ADD",TRANSFER:"TRANSFER",DISPATCH:"DISPATCH"},u={ITEM_NOT_FOUND:"الصنف غير موجود",WRONG_WAREHOUSE:"الصنف ليس في المخزن المحدد",INSUFFICIENT_QUANTITY:"الكمية المطلوبة غير متوفرة",UNAUTHORIZED:"ليس لديك صلاحية للقيام بهذا الإجراء",NETWORK_ERROR:"خطأ في الاتصال بالشبكة",UNKNOWN_ERROR:"حدث خطأ غير متوقع",INVALID_DATA:"بيانات غير صحيحة"};class l{static async addOrUpdateItem(e,r,t=!0){try{const{warehouse_id:o,code:a,color:n,name:s}=e;if(!o||!a||!n||!s)throw new Error("بيانات غير مكتملة: يرجى التأكد من إدخال جميع الحقول المطلوبة (الاسم، الكود، اللون، المخزن)");if(!r)throw new Error("يجب تسجيل الدخول أولاً");const i=this._cleanItemData(e),c=await this._findExistingItem(i);return c?await this._updateExistingItem(c,i,r,t):await this._createNewItem(i,r)}catch(o){throw console.error("Error in addOrUpdateItem:",o),this._handleError(o)}}static async _findExistingItem(e){try{const r=(0,o.rJ)(a.db,"items");if(!e.warehouse_id||!e.code||!e.color||!e.name)return console.warn("Missing required fields for query:",e),null;const t=(0,o.P)(r,(0,o._M)("warehouse_id","==",e.warehouse_id),(0,o._M)("code","==",e.code.trim()),(0,o._M)("color","==",e.color.trim()),(0,o._M)("name","==",e.name.trim())),n=await(0,o.GG)(t);return n.empty?null:{id:n.docs[0].id,...n.docs[0].data()}}catch(r){return console.error("Error finding existing item:",r),null}}static _cleanItemData(e){const r={...e};if(r.name=r.name?.trim()||"",r.code=r.code?.trim()||"",r.color=r.color?.trim()||"",r.supplier=r.supplier?.trim()||"",r.item_location=r.item_location?.trim()||"",r.notes=r.notes?.trim()||"",!r.name)throw new Error("اسم الصنف مطلوب");if(!r.code)throw new Error("كود الصنف مطلوب");if(!r.color)throw new Error("لون الصنف مطلوب");if(!r.warehouse_id)throw new Error("المخزن مطلوب");if(r.cartons_count=Number(r.cartons_count)||0,r.per_carton_count=Number(r.per_carton_count)||1,r.single_bottles_count=Number(r.single_bottles_count)||0,r.supplier=r.supplier||"",r.item_location=r.item_location||"",r.notes=r.notes||"",r.cartons_count<0)throw new Error("عدد الكراتين لا يمكن أن يكون سالباً");if(r.per_carton_count<1)throw new Error("عدد القطع في الكرتونة يجب أن يكون 1 على الأقل");if(r.single_bottles_count<0)throw new Error("عدد القزاز الفردي لا يمكن أن يكون سالباً");return r}static async _updateExistingItem(e,r,t,n){const s=(0,o.wP)(a.db),i=new Date,u={updated_at:i,updated_by:t};let l=0;if(n){const t=e.cartons_count||0,o=r.cartons_count||0;u.cartons_count=t+o,void 0!==r.per_carton_count&&null!==r.per_carton_count&&r.per_carton_count>=1?u.per_carton_count=r.per_carton_count:u.per_carton_count=e.per_carton_count||1;const a=u.per_carton_count;l=o*a,u.single_bottles_count=e.single_bottles_count||0}else void 0!==r.single_bottles_count&&null!==r.single_bottles_count?(u.single_bottles_count=Math.max(0,r.single_bottles_count),l=r.single_bottles_count):u.single_bottles_count=e.single_bottles_count||0,u.cartons_count=e.cartons_count||0,u.per_carton_count=e.per_carton_count||1;const d=e.total_added||0,_=e.remaining_quantity||0;if(u.total_added=d+l,u.remaining_quantity=_+l,void 0!==r.notes&&(u.notes=r.notes),void 0!==r.supplier&&(u.supplier=r.supplier),void 0!==r.item_location&&(u.item_location=r.item_location),u.remaining_quantity<0)throw new Error("الكمية المتبقية لا يمكن أن تكون سالبة");if(u.total_added<d)throw new Error("الكمية المضافة التراكمية لا يمكن أن تقل");const m=(0,o.H9)(a.db,"items",e.id);s.update(m,u);const h=(0,o.H9)((0,o.rJ)(a.db,"transactions"));return s.set(h,{item_id:e.id,from_warehouse:null,to_warehouse:r.warehouse_id,type:c.ADD,cartons_delta:n&&r.cartons_count||0,single_delta:n?0:r.single_bottles_count||0,per_carton_updated:r.per_carton_count,previous_remaining:_,new_remaining:u.remaining_quantity,timestamp:i,user_id:t,notes:r.notes||(n?"إضافة كراتين للمخزن":"إضافة قزاز فردي للمخزن"),created_at:i}),await s.commit(),{type:"updated",id:e.id,addedQuantity:l}}static async _createNewItem(e,r){const t=(0,o.wP)(a.db),n=new Date,s=e.cartons_count||0,i=e.per_carton_count||1,u=e.single_bottles_count||0,l=s*i+u;if(!e.name||!e.code||!e.color||!e.warehouse_id)throw new Error("جميع الحقول المطلوبة يجب أن تكون مملوءة (الاسم، الكود، اللون، المخزن)");if(l<=0)throw new Error("يجب إدخال كمية صحيحة");const d={name:e.name,code:e.code,color:e.color,warehouse_id:e.warehouse_id,cartons_count:s,per_carton_count:i,single_bottles_count:u,total_added:l,remaining_quantity:l,supplier:e.supplier||"",item_location:e.item_location||"",notes:e.notes||"",created_at:n,created_by:r,updated_at:n,updated_by:r},_=(0,o.H9)((0,o.rJ)(a.db,"items"));t.set(_,d);const m=(0,o.H9)((0,o.rJ)(a.db,"transactions"));return t.set(m,{item_id:_.id,from_warehouse:null,to_warehouse:e.warehouse_id,type:c.ADD,cartons_delta:s,single_delta:u,per_carton_updated:i,previous_remaining:0,new_remaining:l,timestamp:n,user_id:r,notes:e.notes||"إنشاء صنف جديد",created_at:n}),await t.commit(),{type:"created",id:_.id,addedQuantity:l}}static async transferItem(e,r){try{const{item_id:t,from_warehouse:n,to_warehouse:i,cartons:l,single_bottles:d,notes:_}=e;if(!t||!n||!i)throw new Error("بيانات النقل غير مكتملة");if(!r)throw new Error("يجب تسجيل الدخول أولاً");const m=Number(l)||0,h=Number(d)||0;if(m<=0&&h<=0)throw new Error("يجب تحديد كمية للنقل");return await(0,o.c4)(a.db,async e=>{const l=(0,o.H9)(a.db,"items",t),d=await e.get(l);if(!d.exists())throw new Error(u.ITEM_NOT_FOUND);const p=d.data();if(p.warehouse_id!==n)throw new Error(u.WRONG_WAREHOUSE);const w=p.per_carton_count||1,g=m*w+h;if(g>p.remaining_quantity)throw new Error(u.INSUFFICIENT_QUANTITY);const f={remaining_quantity:p.remaining_quantity-g,updated_at:new Date,updated_by:r};m>0&&(f.cartons_count=Math.max(0,(p.cartons_count||0)-m)),h>0&&(f.single_bottles_count=Math.max(0,(p.single_bottles_count||0)-h)),await e.update(l,f),await this._handleDestinationItem(e,p,i,m,h,g,r);const E=(0,o.H9)((0,o.rJ)(a.db,"transactions"));return await e.set(E,{item_id:t,from_warehouse:n,to_warehouse:i,type:c.TRANSFER,cartons_delta:-m,single_delta:-h,per_carton_updated:p.per_carton_count,previous_remaining:p.remaining_quantity,new_remaining:f.remaining_quantity,timestamp:new Date,user_id:r,notes:_||`نقل من ${s[n]} إلى ${s[i]}`,created_at:new Date}),{success:!0,transferQty:g,sourceItemId:t,destinationWarehouse:i}})}catch(t){throw console.error("Error in transferItem:",t),this._handleError(t)}}static async _handleDestinationItem(e,r,t,n,s,i,c){const u=(0,o.rJ)(a.db,"items"),l=(0,o.P)(u,(0,o._M)("warehouse_id","==",t),(0,o._M)("code","==",r.code),(0,o._M)("color","==",r.color),(0,o._M)("name","==",r.name)),d=await(0,o.GG)(l),_=new Date;if(!d.empty&&d.docs.length>0){const r=d.docs[0],t=r.data(),u={total_added:(t.total_added||0)+i,remaining_quantity:(t.remaining_quantity||0)+i,cartons_count:(t.cartons_count||0)+n,single_bottles_count:(t.single_bottles_count||0)+s,updated_at:_,updated_by:c},l=(0,o.H9)(a.db,"items",r.id);await e.update(l,u)}else{const u={name:r.name,code:r.code,color:r.color,warehouse_id:t,cartons_count:n,per_carton_count:r.per_carton_count||1,single_bottles_count:s,total_added:i,remaining_quantity:i,supplier:r.supplier||"",item_location:r.item_location||"",notes:r.notes||"",created_at:_,created_by:c,updated_at:_,updated_by:c},l=(0,o.H9)((0,o.rJ)(a.db,"items"));await e.set(l,u)}}static async dispatchItem(e,r){try{const{item_id:t,from_warehouse:n,to_destination:s,cartons:l,single_bottles:d,notes:_}=e;if(!t||!n||!s)throw new Error("بيانات الصرف غير مكتملة");if(!r)throw new Error("يجب تسجيل الدخول أولاً");const m=Number(l)||0,h=Number(d)||0;if(m<=0&&h<=0)throw new Error("يجب تحديد كمية للصرف");return await(0,o.c4)(a.db,async e=>{const l=(0,o.H9)(a.db,"items",t),d=await e.get(l);if(!d.exists())throw new Error(u.ITEM_NOT_FOUND);const p=d.data();if(p.warehouse_id!==n)throw new Error(u.WRONG_WAREHOUSE);const w=p.per_carton_count||1,g=m*w+h;if(g>p.remaining_quantity)throw new Error(u.INSUFFICIENT_QUANTITY);const f={remaining_quantity:p.remaining_quantity-g,updated_at:new Date,updated_by:r};m>0&&(f.cartons_count=Math.max(0,(p.cartons_count||0)-m)),h>0&&(f.single_bottles_count=Math.max(0,(p.single_bottles_count||0)-h)),await e.update(l,f);const E=(0,o.H9)((0,o.rJ)(a.db,"transactions"));return await e.set(E,{item_id:t,from_warehouse:n,to_warehouse:s,type:c.DISPATCH,cartons_delta:-m,single_delta:-h,per_carton_updated:p.per_carton_count,previous_remaining:p.remaining_quantity,new_remaining:f.remaining_quantity,timestamp:new Date,user_id:r,notes:_||`صرف إلى ${i[s]||s}`,created_at:new Date}),{success:!0,dispatchQty:g,itemId:t,destination:s}})}catch(t){throw console.error("Error in dispatchItem:",t),this._handleError(t)}}static async getLowStockItems(e=null){try{let r=(0,o.rJ)(a.db,"items");r=e?(0,o.P)(r,(0,o._M)("warehouse_id","==",e),(0,o._M)("remaining_quantity","<",10)):(0,o.P)(r,(0,o._M)("remaining_quantity","<",10));const t=await(0,o.GG)(r);return t.docs.map(e=>({id:e.id,...e.data(),_display:{warehouse:s[e.data().warehouse_id]||e.data().warehouse_id}}))}catch(r){throw console.error("Error in getLowStockItems:",r),this._handleError(r)}}static async getRecentTransactions(e=50){try{const r=(0,o.P)((0,o.rJ)(a.db,"transactions"),(0,o.My)("timestamp","desc")),t=await(0,o.GG)(r),n=t.docs.slice(0,e).map(e=>({id:e.id,...e.data()}));return n.map(e=>({...e,_display:{from_warehouse:s[e.from_warehouse]||e.from_warehouse,to_warehouse:s[e.to_warehouse]||i[e.to_warehouse]||e.to_warehouse}}))}catch(r){throw console.error("Error in getRecentTransactions:",r),this._handleError(r)}}static async getWarehouseItems(e){try{if(!e)throw new Error("يجب تحديد المخزن");const r=(0,o.P)((0,o.rJ)(a.db,"items"),(0,o._M)("warehouse_id","==",e),(0,o.My)("name")),t=await(0,o.GG)(r);return t.docs.map(e=>({id:e.id,...e.data(),_display:{warehouse:s[e.data().warehouse_id]||e.data().warehouse_id}}))}catch(r){throw console.error("Error in getWarehouseItems:",r),this._handleError(r)}}static async getAllItems(e=50){try{const r=(0,o.P)((0,o.rJ)(a.db,"items"),(0,o.My)("name")),t=await(0,o.GG)(r),n=t.docs.slice(0,e).map(e=>({id:e.id,...e.data()}));return n.map(e=>({...e,_display:{warehouse:s[e.warehouse_id]||e.warehouse_id}}))}catch(r){throw console.error("Error in getAllItems:",r),this._handleError(r)}}static async searchItems(e,r=null){try{if(!e||e.trim().length<2)throw new Error("يجب إدخال مصطلح بحث مكون من حرفين على الأقل");const t=e.toLowerCase().trim();let o=[];return o=r?await this.getWarehouseItems(r):await this.getAllItems(1e3),o.filter(e=>e.name?.toLowerCase().includes(t)||e.code?.toLowerCase().includes(t)||e.color?.toLowerCase().includes(t)||e.supplier?.toLowerCase().includes(t))}catch(t){throw console.error("Error in searchItems:",t),this._handleError(t)}}static async getItemById(e){try{if(!e)throw new Error("معرف الصنف مطلوب");const r=await(0,o.x7)((0,o.H9)(a.db,"items",e));if(!r.exists())throw new Error(u.ITEM_NOT_FOUND);return{id:r.id,...r.data(),_display:{warehouse:s[r.data().warehouse_id]||r.data().warehouse_id}}}catch(r){throw console.error("Error in getItemById:",r),this._handleError(r)}}static async updateItemDetails(e,r,t){try{if(!e||!t)throw new Error("معرف الصنف ومعرف المستخدم مطلوبان");const n=["supplier","item_location","notes","per_carton_count"],s={};for(const e of n)void 0!==r[e]&&(s[e]=r[e]);if(void 0!==s.per_carton_count&&s.per_carton_count<1)throw new Error("عدد القطع في الكرتونة يجب أن يكون 1 على الأقل");s.updated_at=new Date,s.updated_by=t;const i=(0,o.H9)(a.db,"items",e);return await(0,o.mZ)(i,s),{success:!0,itemId:e}}catch(n){throw console.error("Error in updateItemDetails:",n),this._handleError(n)}}static async getWarehouseStats(e=null){try{let r=(0,o.rJ)(a.db,"items");e&&(r=(0,o.P)(r,(0,o._M)("warehouse_id","==",e)));const t=await(0,o.GG)(r),n=t.docs.map(e=>e.data()),i=n.length,c=n.reduce((e,r)=>e+(r.remaining_quantity||0),0),u=n.filter(e=>(e.remaining_quantity||0)<10).length,l=n.filter(e=>0===(e.remaining_quantity||0)).length;return{totalItems:i,totalQuantity:c,lowStockItems:u,outOfStockItems:l,warehouse:e?s[e]:"جميع المخازن"}}catch(r){throw console.error("Error in getWarehouseStats:",r),this._handleError(r)}}static convertForDisplay(e){return Array.isArray(e)?e.map(e=>this._addDisplayLabels(e)):this._addDisplayLabels(e)}static _addDisplayLabels(e){return e?{...e,_display:{warehouse:s[e.warehouse_id]||e.warehouse_id}}:e}static _handleError(e){if(console.error("Inventory Service Error:",e),e.code)switch(e.code){case"permission-denied":return new Error("ليس لديك صلاحية للقيام بهذا الإجراء");case"unavailable":return new Error("الخدمة غير متاحة حالياً. يرجى المحاولة لاحقاً");case"resource-exhausted":return new Error("تم تجاوز الحد المسموح. يرجى المحاولة لاحقاً");case"failed-precondition":return new Error("البيانات غير صالحة للعملية المطلوبة");case"invalid-argument":return new Error("بيانات غير صحيحة");default:return new Error(e.message||u.UNKNOWN_ERROR)}return e.message&&e.message.includes(" ")?e:new Error(e.message||u.UNKNOWN_ERROR)}static calculateTotalQuantity(e,r,t){const o=(Number(e)||0)*(Number(r)||1),a=Number(t)||0;return o+a}static validateItemData(e,r="create"){const t=[];if(e.name?.trim()||t.push("الاسم مطلوب"),e.code?.trim()||t.push("الكود مطلوب"),e.color?.trim()||t.push("اللون مطلوب"),e.warehouse_id||t.push("المخزن مطلوب"),"create"===r){const r=this.calculateTotalQuantity(e.cartons_count,e.per_carton_count,e.single_bottles_count);r<=0&&t.push("يجب إدخال كمية صحيحة")}if(t.length>0)throw new Error(t.join("، "));return!0}}},203:function(e,r,t){var o=t(884),a=t(496),n=t(556);class s{constructor(){this.usersCollection="users",this.logsCollection="user_logs",this.profilesCollection="user_profiles"}async _checkSuperAdminPermission(){try{if(!n.j2.currentUser)throw new Error("يجب تسجيل الدخول أولاً");const e=await(0,o.x7)((0,o.H9)(n.db,this.usersCollection,n.j2.currentUser.uid));if(!e.exists())throw new Error("ملف المستخدم غير موجود");const r=e.data();if("superadmin"!==r.role)throw new Error("ليس لديك صلاحية لإدارة المستخدمين");return r}catch(e){throw console.error("Permission check error:",e),e}}async getUsers(e={}){try{await this._checkSuperAdminPermission();const{page:r=1,limit:t=20,search:a="",role:s="",is_active:i=null,sort_by:c="created_at",sort_order:u="desc"}=e;let l=(0,o.rJ)(n.db,this.usersCollection);const d=[];s&&d.push((0,o._M)("role","==",s)),null!==i&&d.push((0,o._M)("is_active","==",i)),d.push((0,o.My)(c,u)),l=(0,o.P)(l,...d);const _=await(0,o.GG)(l);let m=[];_.forEach(e=>{const r=e.data();this._userMatchesSearch(r,a)&&m.push({id:e.id,...r,created_at:this._formatTimestamp(r.created_at),updated_at:this._formatTimestamp(r.updated_at),last_login:this._formatTimestamp(r.last_login)})});const h=m.length,p=(r-1)*t,w=m.slice(p,p+t);return{success:!0,data:w,pagination:{currentPage:r,totalPages:Math.ceil(h/t),totalItems:h,itemsPerPage:t}}}catch(r){return console.error("UserService.getUsers Error:",r),{success:!1,error:this._handleFirebaseError(r),data:[],pagination:{currentPage:1,totalPages:0,totalItems:0,itemsPerPage:20}}}}async getUserById(e){try{const r=(0,o.H9)(n.db,this.usersCollection,e),t=await(0,o.x7)(r);if(!t.exists())return{success:!1,error:"المستخدم غير موجود",data:null};const a=t.data(),s={id:t.id,...a,created_at:this._formatTimestamp(a.created_at),updated_at:this._formatTimestamp(a.updated_at),last_login:this._formatTimestamp(a.last_login)};return{success:!0,data:s,message:"تم تحميل المستخدم بنجاح"}}catch(r){return console.error("UserService.getUserById Error:",r),{success:!1,error:this._handleFirebaseError(r),data:null}}}async createUser(e){try{await this._checkSuperAdminPermission();const r=this.validateUserData(e,!1);if(!r.isValid)return{success:!1,error:r.errors[0],data:null};const t=await(0,a.eJ)(n.j2,e.email.trim().toLowerCase(),e.password),s=t.user,i=s.uid,c={name:e.name.trim(),email:e.email.trim().toLowerCase(),phone:e.phone?.trim()||null,role:e.role,is_active:!1!==e.is_active,allowed_warehouses:e.allowed_warehouses||[],created_at:(0,o.O5)(),updated_at:(0,o.O5)(),created_by:n.j2.currentUser?.uid||"system",email_verified:!1,last_login:null,profile_complete:!1};await(0,a.r7)(s,{displayName:e.name.trim()}),await(0,a.gA)(s);const u=(0,o.H9)(n.db,this.usersCollection,i);await(0,o.BN)(u,c);const l=(0,o.H9)(n.db,this.profilesCollection,i);return await(0,o.BN)(l,{user_id:i,preferences:{language:"ar",theme:"light",notifications:!0},created_at:(0,o.O5)(),updated_at:(0,o.O5)()}),await this._logUserAction("create",i,{name:c.name,email:c.email,role:c.role}),{success:!0,data:{id:i,...c,created_at:(new Date).toISOString(),updated_at:(new Date).toISOString()},message:"تم إنشاء المستخدم بنجاح"}}catch(r){return console.error("UserService.createUser Error:",r),{success:!1,error:this._handleFirebaseError(r),data:null}}}async updateUser(e,r){try{await this._checkSuperAdminPermission();const s=await this.getUserById(e);if(!s.success)return s;const i=this.validateUserData(r,!0);if(!i.isValid)return{success:!1,error:i.errors[0],data:null};const c={name:r.name?.trim()||s.data.name,phone:r.phone?.trim()||s.data.phone||null,role:r.role||s.data.role,is_active:!1!==r.is_active,allowed_warehouses:r.allowed_warehouses||s.data.allowed_warehouses||[],updated_at:(0,o.O5)(),updated_by:n.j2.currentUser?.uid};if(r.name&&r.name!==s.data.name)try{const t=n.j2.currentUser;t?.uid===e&&await(0,a.r7)(t,{displayName:r.name.trim()})}catch(t){console.warn("Could not update Firebase Auth profile:",t)}const u=(0,o.H9)(n.db,this.usersCollection,e);return await(0,o.mZ)(u,c),await this._logUserAction("update",e,{name:c.name,role:c.role,is_active:c.is_active}),{success:!0,data:{...s.data,...c,updated_at:(new Date).toISOString()},message:"تم تحديث المستخدم بنجاح"}}catch(t){return console.error("UserService.updateUser Error:",t),{success:!1,error:this._handleFirebaseError(t),data:null}}}async deleteUser(e){try{await this._checkSuperAdminPermission();const r=(0,o.H9)(n.db,this.usersCollection,e),t=await(0,o.x7)(r);if(!t.exists())return{success:!1,error:"المستخدم غير موجود"};if(n.j2.currentUser?.uid===e)return{success:!1,error:"لا يمكن حذف حسابك الشخصي"};const a=t.data();if("superadmin"===a.role)return{success:!1,error:"لا يمكن حذف مشرف عام آخر"};await(0,o.kd)(r);const s=(0,o.H9)(n.db,this.profilesCollection,e);return await(0,o.kd)(s),await this._logUserAction("delete",e,{name:a.name,email:a.email}),{success:!0,message:"تم حذف المستخدم بنجاح"}}catch(r){return console.error("UserService.deleteUser Error:",r),{success:!1,error:this._handleFirebaseError(r)}}}async updateUserStatus(e,r){try{await this._checkSuperAdminPermission();const t=(0,o.H9)(n.db,this.usersCollection,e),a=await(0,o.x7)(t);if(!a.exists())return{success:!1,error:"المستخدم غير موجود"};const s=a.data();return n.j2.currentUser?.uid===e&&"superadmin"===s.role?{success:!1,error:"لا يمكن تعطيل حساب المشرف العام"}:r||"superadmin"!==s.role?(await(0,o.mZ)(t,{is_active:r,updated_at:(0,o.O5)(),updated_by:n.j2.currentUser?.uid}),await this._logUserAction(r?"activate":"deactivate",e,{name:s.name,previous_status:s.is_active,new_status:r}),{success:!0,message:`تم ${r?"تفعيل":"تعطيل"} المستخدم بنجاح`}):{success:!1,error:"لا يمكن تعطيل مشرف عام آخر"}}catch(t){return console.error("UserService.updateUserStatus Error:",t),{success:!1,error:this._handleFirebaseError(t)}}}async searchUsers(e,r=10){try{await this._checkSuperAdminPermission();const t=(0,o.rJ)(n.db,this.usersCollection),a=await(0,o.GG)(t),s=[];a.forEach(r=>{const t=r.data();this._userMatchesSearch(t,e)&&s.push({id:r.id,...t,created_at:this._formatTimestamp(t.created_at),updated_at:this._formatTimestamp(t.updated_at)})});const i=s.sort((r,t)=>{const o=this._calculateSearchScore(r,e),a=this._calculateSearchScore(t,e);return a-o});return{success:!0,data:i.slice(0,r),message:"تم البحث بنجاح"}}catch(t){return console.error("UserService.searchUsers Error:",t),{success:!1,error:this._handleFirebaseError(t),data:[]}}}async getUserStats(){try{await this._checkSuperAdminPermission();const e=(0,o.rJ)(n.db,this.usersCollection),r=await(0,o.GG)(e);let t=0,a=0,s=0,i=0,c=0;return r.forEach(e=>{const r=e.data();switch(t++,!1!==r.is_active&&a++,r.role){case"superadmin":s++;break;case"warehouse_manager":i++;break;case"company_manager":c++;break}}),{success:!0,data:{total_users:t,active_users:a,inactive_users:t-a,superadmins:s,warehouse_managers:i,company_managers:c,roles_distribution:{superadmin:s,warehouse_manager:i,company_manager:c}}}}catch(e){return console.error("UserService.getUserStats Error:",e),{success:!1,error:this._handleFirebaseError(e),data:null}}}generateRandomPassword(e=12){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";let t="";for(let o=0;o<e;o++){const e=Math.floor(Math.random()*r.length);t+=r[e]}return t}async _logUserAction(e,r,t=null){try{const a=(0,o.rJ)(n.db,this.logsCollection),s={action:e,user_id:r,performed_by:n.j2.currentUser?.uid||"system",performed_by_name:n.j2.currentUser?.displayName||"System",data:t?JSON.stringify(t):null,timestamp:(0,o.O5)(),ip_address:"unknown"};await(0,o.BN)((0,o.H9)(a),s)}catch(a){console.error("Failed to log user action:",a)}}_userMatchesSearch(e,r){if(!r.trim())return!0;const t=r.toLowerCase().trim(),o=(e.name||"").toLowerCase(),a=(e.email||"").toLowerCase(),n=(e.phone||"").toLowerCase();return o.includes(t)||a.includes(t)||n.includes(t)}_calculateSearchScore(e,r){let t=0;const o=r.toLowerCase().trim();return e.name?.toLowerCase().includes(o)&&(t+=3),e.email?.toLowerCase().includes(o)&&(t+=2),e.phone?.toLowerCase().includes(o)&&(t+=1),t}_formatTimestamp(e){return e?e instanceof o.Dc||e.toDate?e.toDate().toISOString():e:null}_handleFirebaseError(e){console.error("Firebase Error:",e.code,e.message);const r={"auth/email-already-in-use":"البريد الإلكتروني مسجل مسبقاً","auth/invalid-email":"البريد الإلكتروني غير صالح","auth/operation-not-allowed":"عملية غير مسموحة","auth/weak-password":"كلمة المرور ضعيفة جداً","auth/user-disabled":"هذا الحساب معطل","auth/user-not-found":"المستخدم غير موجود","auth/wrong-password":"كلمة المرور غير صحيحة","auth/too-many-requests":"محاولات كثيرة جداً، يرجى الانتظار","permission-denied":"ليس لديك صلاحية للقيام بهذا الإجراء","not-found":"المستند غير موجود","already-exists":"المستند موجود مسبقاً",unavailable:"الخدمة غير متاحة حالياً"};return r[e.code]||e.message||"حدث خطأ غير متوقع"}validateUserData(e,r=!1){const t=[];if((!e.name||e.name.trim().length<2)&&t.push("الاسم يجب أن يكون على الأقل حرفين"),!r||e.email){const r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;e.email&&r.test(e.email)||t.push("البريد الإلكتروني غير صالح")}e.phone&&!/^01[0-9]{9}$/.test(e.phone)&&t.push("رقم الهاتف يجب أن يبدأ بـ 01 ويتكون من 11 رقماً");const o=["superadmin","warehouse_manager","company_manager"];return e.role&&o.includes(e.role)||t.push("الدور غير صالح"),r||(!e.password||e.password.length<8)&&t.push("كلمة المرور يجب أن تكون 8 أحرف على الأقل"),"warehouse_manager"===e.role&&(e.allowed_warehouses&&0!==e.allowed_warehouses.length||t.push("يجب اختيار مخزن واحد على الأقل لمدير المخازن")),{isValid:0===t.length,errors:t}}formatUserForDisplay(e){return{id:e.id,name:e.name||"غير معروف",email:e.email||"",phone:e.phone||"-",role:e.role||"user",role_name:this.getRoleName(e.role),is_active:!1!==e.is_active,status:!1!==e.is_active?"نشط":"غير نشط",status_color:!1!==e.is_active?"green":"red",allowed_warehouses:e.allowed_warehouses||[],created_at:e.created_at?new Date(e.created_at).toLocaleDateString("ar-EG"):"-",updated_at:e.updated_at?new Date(e.updated_at).toLocaleDateString("ar-EG"):"-",last_login:e.last_login?new Date(e.last_login).toLocaleDateString("ar-EG"):"لم يسجل دخول"}}getRoleName(e){const r={superadmin:"المشرف العام",warehouse_manager:"مدير المخازن",company_manager:"مدير الشركة"};return r[e]||e}getRolePermissions(e){const r={superadmin:["الوصول الكامل إلى جميع المخازن","إدارة المستخدمين والأدوار","إنشاء وتعديل وحذف الأصناف","إدارة الحركات والنقل","تصدير التقارير والبيانات","إعدادات النظام"],warehouse_manager:["الوصول إلى المخازن المحددة فقط","إنشاء وتعديل الأصناف في المخازن المسموحة","إدارة الحركات والنقل بين المخازن المسموحة","عرض التقارير للمخازن المسموحة","تصدير بيانات المخازن المسموحة"],company_manager:["عرض جميع البيانات للقراءة فقط","تصفية البيانات والتقارير","تصدير التقارير والبيانات","لا يمكن التعديل أو الحذف"]};return r[e]||[]}}const i=new s;r.A=i},329:function(e,r,t){var o=t(751),a=t(641);const n={id:"app",dir:"rtl",class:"min-h-screen bg-gray-50"};function s(e,r,t,o,s,i){const c=(0,a.g2)("router-view");return(0,a.uX)(),(0,a.CE)("div",n,[(0,a.bF)(c)])}var i=t(278),c={name:"App",setup(){const e=(0,i.Pj)();return(0,a.sV)(async()=>{await e.dispatch("initializeAuth"),await e.dispatch("loadWarehouses")}),{}}},u=t(262);const l=(0,u.A)(c,[["render",s]]);var d=l,_=t(499);const m=[{path:"/",name:"Dashboard",component:()=>Promise.all([t.e(96),t.e(502),t.e(217),t.e(696),t.e(315),t.e(523)]).then(t.bind(t,989)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"]}},{path:"/login",name:"Login",component:()=>t.e(176).then(t.bind(t,176)),meta:{requiresGuest:!0}},{path:"/inventory",name:"Inventory",component:()=>Promise.all([t.e(96),t.e(502),t.e(217),t.e(315),t.e(848)]).then(t.bind(t,296)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"],permissions:{company_manager:"viewer",warehouse_manager:"full_access"}}},{path:"/inventory/add",name:"AddInventory",component:()=>Promise.all([t.e(96),t.e(502),t.e(217),t.e(315),t.e(848)]).then(t.bind(t,296)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"}}},{path:"/inventory/edit/:id",name:"EditInventory",component:()=>Promise.all([t.e(96),t.e(502),t.e(217),t.e(315),t.e(848)]).then(t.bind(t,296)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"}}},{path:"/transfers",name:"Transfers",component:()=>Promise.all([t.e(502),t.e(513)]).then(t.bind(t,287)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"}}},{path:"/dispatch",name:"Dispatch",component:()=>Promise.all([t.e(217),t.e(569)]).then(t.bind(t,877)),meta:{requiresAuth:!0,allowedRoles:["superadmin","warehouse_manager"],permissions:{company_manager:"none",warehouse_manager:"full_access"}}},{path:"/transactions",name:"Transactions",component:()=>t.e(989).then(t.bind(t,370)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"],permissions:{company_manager:"viewer",warehouse_manager:"viewer"}}},{path:"/reports",name:"Reports",component:()=>t.e(621).then(t.bind(t,621)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager"],permissions:{company_manager:"viewer",warehouse_manager:"none"}}},{path:"/users",name:"Users",component:()=>Promise.all([t.e(696),t.e(639)]).then(t.bind(t,315)),meta:{requiresAuth:!0,allowedRoles:["superadmin"]}},{path:"/profile",name:"Profile",component:()=>t.e(630).then(t.bind(t,630)),meta:{requiresAuth:!0,allowedRoles:["superadmin","company_manager","warehouse_manager"]}},{path:"/unauthorized",name:"Unauthorized",component:{template:'\n        <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center px-4">\n          <div class="text-center">\n            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full mb-6">\n              <svg class="w-8 h-8 text-red-600 dark:text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0 0v2m0-2h2m-2 0H9m3-6a3 3 0 110-6 3 3 0 010 6zm2 7a9 9 0 11-18 0 9 9 0 0118 0z"/>\n              </svg>\n            </div>\n            <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">صلاحية مرفوضة</h1>\n            <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">\n              ليس لديك الصلاحية للوصول إلى هذه الصفحة\n            </p>\n            <router-link to="/" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">\n              العودة للرئيسية\n            </router-link>\n          </div>\n        </div>\n      '}},{path:"/:pathMatch(.*)*",name:"NotFound",component:{template:'\n        <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center px-4">\n          <div class="text-center">\n            <h1 class="text-6xl font-bold text-gray-900 dark:text-white mb-4">404</h1>\n            <p class="text-xl text-gray-600 dark:text-gray-400 mb-8">\n              الصفحة غير موجودة\n            </p>\n            <router-link to="/" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors duration-200">\n              العودة للرئيسية\n            </router-link>\n          </div>\n        </div>\n      '}}],h=(0,_.aE)({history:(0,_.LA)(),routes:m});h.beforeEach((e,r,t)=>{const o=(0,i.Pj)(),a=o.state.user,n=o.state.userProfile;if(!e.meta.requiresAuth||a)if(e.meta.requiresGuest&&a)t("/");else{if(a&&e.meta.allowedRoles){const r=n?.role;if(!r)return void t("/unauthorized");if(!e.meta.allowedRoles.includes(r))return void t("/unauthorized");if(e.meta.permissions){const o=e.meta.permissions[r];if("none"===o)return void t("/unauthorized")}if("warehouse_manager"===r){const r=n?.allowed_warehouses||[];if(e.name?.includes("Inventory")&&0===r.length)return void t("/unauthorized")}}t()}else t("/login")});var p=h,w=t(556),g=t(496),f=t(884),E=t(62),y=t(203);const b={arabicToEnglish:{"الاسم":"name","الكود":"code","اللون":"color","المخزن_id":"warehouse_id","المخزن":"warehouse_id","عدد_الكراتين":"cartons_count","عدد_في_الكرتونه":"per_carton_count","عدد_القزاز_الفردي":"single_bottles_count","الكميه_المضافه":"total_added","الكميه_المتبقيه":"remaining_quantity","المورد":"supplier","مكان_الصنف":"item_location"},englishToArabic:E.XY};var R=(0,i.y$)({state:{user:null,userProfile:null,loading:!1,warehouses:[],warehousesLoaded:!1,inventory:[],transactions:[],itemHistory:[],filters:{warehouse:"",search:""},authError:null,operationLoading:!1,operationError:null,fieldMappings:b},mutations:{SET_USER(e,r){e.user=r},SET_USER_PROFILE(e,r){e.userProfile=r},SET_LOADING(e,r){e.loading=r},SET_OPERATION_LOADING(e,r){e.operationLoading=r},SET_OPERATION_ERROR(e,r){e.operationError=r},SET_WAREHOUSES(e,r){e.warehouses=r},SET_WAREHOUSES_LOADED(e,r){e.warehousesLoaded=r},SET_INVENTORY(e,r){e.inventory=r},SET_TRANSACTIONS(e,r){e.transactions=r},SET_ITEM_HISTORY(e,r){e.itemHistory=r},SET_FILTERS(e,r){e.filters={...e.filters,...r}},ADD_ITEM(e,r){e.inventory.push(r)},UPDATE_ITEM(e,r){const t=e.inventory.findIndex(e=>e.id===r.id);-1!==t&&e.inventory.splice(t,1,r)},REMOVE_ITEM(e,r){e.inventory=e.inventory.filter(e=>e.id!==r)},SET_AUTH_ERROR(e,r){e.authError=r},CLEAR_OPERATION_ERROR(e){e.operationError=null}},actions:{async initializeAuth({commit:e,dispatch:r}){return new Promise(t=>{(0,g.hg)(w.j2,async o=>{if(o){e("SET_USER",o);try{const t=await(0,f.x7)((0,f.H9)(w.db,"users",o.uid));if(t.exists()){const o=t.data();e("SET_USER_PROFILE",o),console.log("User profile loaded:",o.role,o.allowed_warehouses),await r("loadWarehouses"),r("subscribeToInventory"),r("subscribeToTransactions")}else console.log("User document not found, creating default profile..."),await r("createUserProfile",o)}catch(a){console.error("Error loading user profile:",a),e("SET_AUTH_ERROR","فشل في تحميل بيانات المستخدم")}}else e("SET_USER",null),e("SET_USER_PROFILE",null),e("SET_INVENTORY",[]),e("SET_TRANSACTIONS",[]),e("SET_ITEM_HISTORY",[]),e("SET_WAREHOUSES_LOADED",!1);t()})})},async createUserProfile({commit:e,dispatch:r},t){try{let o={email:t.email,role:"company_manager",name:t.email.split("@")[0],allowed_warehouses:[],permissions:["view_reports"],created_at:new Date};"superadmin@monofia.com"===t.email?o={...o,role:"superadmin",name:"المشرف العام",allowed_warehouses:["main_warehouse","tera_warehouse","shobeen_warehouse","hyper_warehouse","matbaa_warehouse","ghabashi_warehouse","factory","zahra"],permissions:["all"]}:"warehouse@monofia.com"===t.email?o={...o,role:"warehouse_manager",name:"مدير المخازن",allowed_warehouses:["main_warehouse","tera_warehouse","shobeen_warehouse","hyper_warehouse"],permissions:["full_access","manage_inventory","create_transfers","view_reports","delete_items","update_items"]}:"company@monofia.com"===t.email&&(o={...o,role:"company_manager",name:"مدير الشركة",allowed_warehouses:["main_warehouse","tera_warehouse","shobeen_warehouse","hyper_warehouse","matbaa_warehouse","ghabashi_warehouse"],permissions:["view_reports","export_data"]}),await(0,f.BN)((0,f.H9)(w.db,"users",t.uid),o),e("SET_USER_PROFILE",o),await r("loadWarehouses")}catch(o){throw console.error("Error creating user profile:",o),o}},async login({commit:e,dispatch:r},{email:t,password:o}){e("SET_LOADING",!0),e("SET_AUTH_ERROR",null);try{console.log("Attempting login with:",t);const a=await(0,g.x9)(w.j2,t,o),n=a.user;console.log("Login successful, user:",n.uid);const s=await(0,f.x7)((0,f.H9)(w.db,"users",n.uid));if(s.exists()){const t=s.data();e("SET_USER_PROFILE",t),console.log("User profile loaded:",t.role,t.allowed_warehouses),await r("loadWarehouses"),r("subscribeToInventory"),r("subscribeToTransactions")}else console.log("Creating new user profile..."),await r("createUserProfile",n);return e("SET_USER",n),n}catch(a){console.error("Login error details:",a);const r=O(a.code);throw e("SET_AUTH_ERROR",r),new Error(r)}finally{e("SET_LOADING",!1)}},async logout({commit:e}){try{await(0,g.CI)(w.j2),e("SET_USER",null),e("SET_USER_PROFILE",null),e("SET_INVENTORY",[]),e("SET_TRANSACTIONS",[]),e("SET_ITEM_HISTORY",[]),e("SET_AUTH_ERROR",null),e("SET_OPERATION_ERROR",null),e("SET_WAREHOUSES_LOADED",!1)}catch(r){throw console.error("Logout error:",r),r}},async loadWarehouses({commit:e}){try{const r=[{id:"main_warehouse",name_ar:"مخزن شارع الشيخ",name_en:"Main Warehouse",type:"primary",is_main:!0},{id:"tera_warehouse",name_ar:"مخزن الترعه",name_en:"Teraa Warehouse",type:"primary"},{id:"shobeen_warehouse",name_ar:"مخزن موقف شبين",name_en:"Shobeen Warehouse",type:"primary"},{id:"hyper_warehouse",name_ar:"مخزن هايبر التهامي",name_en:"Hyper El Tahamy Warehouse",type:"primary"},{id:"matbaa_warehouse",name_ar:"مخزن المطبعه",name_en:"Matbaa Warehouse",type:"primary"},{id:"ghabashi_warehouse",name_ar:"مخزن الغباشي",name_en:"Ghabashi Warehouse",type:"primary"},{id:"factory",name_ar:"صرف الي مصنع البران",name_en:"Al Bran Factory Dispatch",type:"dispatch"},{id:"zahra",name_ar:"صرف الي مخزن الزهراء",name_en:"Al Zahra Warehouse Dispatch",type:"dispatch"}];e("SET_WAREHOUSES",r),e("SET_WAREHOUSES_LOADED",!0),console.log("Warehouses loaded:",r.length)}catch(r){console.error("Error loading warehouses:",r),e("SET_WAREHOUSES_LOADED",!1)}},async loadAllUsers({commit:e,getters:r}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.canManageUsers)throw new Error("ليس لديك صلاحية لعرض المستخدمين");const e=await y.A.getUsers();if(e.success)return e.data;throw new Error(e.error||"فشل في تحميل المستخدمين")}catch(t){throw console.error("Error loading users:",t),e("SET_OPERATION_ERROR",t.message),t}finally{e("SET_OPERATION_LOADING",!1)}},async createUser({commit:e,getters:r},t){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.canManageUsers)throw new Error("ليس لديك صلاحية لإضافة مستخدمين");const e=await y.A.createUser(t);if(e.success)return{success:!0,data:e.data,message:e.message};throw new Error(e.error||"فشل في إنشاء المستخدم")}catch(o){return console.error("Error creating user:",o),e("SET_OPERATION_ERROR",o.message),{success:!1,error:o.message}}finally{e("SET_OPERATION_LOADING",!1)}},async updateUser({commit:e,getters:r},{userId:t,userData:o}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.canManageUsers)throw new Error("ليس لديك صلاحية لتحديث المستخدمين");const e=await y.A.updateUser(t,o);if(e.success)return{success:!0,data:e.data,message:e.message};throw new Error(e.error||"فشل في تحديث المستخدم")}catch(a){return console.error("Error updating user:",a),e("SET_OPERATION_ERROR",a.message),{success:!1,error:a.message}}finally{e("SET_OPERATION_LOADING",!1)}},async deleteUser({commit:e,getters:r},t){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.canManageUsers)throw new Error("ليس لديك صلاحية لحذف المستخدمين");const e=await y.A.deleteUser(t);if(e.success)return{success:!0,message:e.message};throw new Error(e.error||"فشل في حذف المستخدم")}catch(o){return console.error("Error deleting user:",o),e("SET_OPERATION_ERROR",o.message),{success:!1,error:o.message}}finally{e("SET_OPERATION_LOADING",!1)}},async updateUserStatus({commit:e,getters:r},{userId:t,isActive:o}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.canManageUsers)throw new Error("ليس لديك صلاحية لتغيير حالة المستخدمين");const e=await y.A.updateUserStatus(t,o);if(e.success)return{success:!0,message:e.message};throw new Error(e.error||"فشل في تغيير حالة المستخدم")}catch(a){return console.error("Error updating user status:",a),e("SET_OPERATION_ERROR",a.message),{success:!1,error:a.message}}finally{e("SET_OPERATION_LOADING",!1)}},async getUserStats({commit:e,getters:r}){try{if(!r.canManageUsers)throw new Error("ليس لديك صلاحية لعرض إحصائيات المستخدمين");const e=await y.A.getUserStats();if(e.success)return e.data;throw new Error(e.error||"فشل في تحميل إحصائيات المستخدمين")}catch(t){throw console.error("Error loading user stats:",t),t}},async checkExistingItem({commit:e,state:r},{code:t,color:o,name:a,warehouse_id:n}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!r.user?.uid)throw new Error("معرف المستخدم غير متوفر");if(!t?.trim()||!o?.trim()||!a?.trim()||!n)throw new Error("جميع الحقول المطلوبة للبحث عن الصنف يجب أن تكون مملوءة");const e=t.trim(),s=o.trim(),i=a.trim();console.log("Checking existing item with:",{cleanCode:e,cleanColor:s,cleanName:i,warehouse_id:n});const c=(0,f.rJ)(w.db,"items"),u=(0,f.P)(c,(0,f._M)("warehouse_id","==",n),(0,f._M)("code","==",e),(0,f._M)("color","==",s),(0,f._M)("name","==",i)),l=await(0,f.GG)(u);if(!l.empty){const e=l.docs[0],r={id:e.id,...e.data()};return console.log("Found existing item:",r.id),{exists:!0,item:E.cE.convertForDisplay(r)}}return console.log("No existing item found"),{exists:!1}}catch(s){console.error("Error checking existing item:",s);const r=s.message||"حدث خطأ في التحقق من وجود الصنف";throw e("SET_OPERATION_ERROR",r),s}finally{e("SET_OPERATION_LOADING",!1)}},async addInventoryItemAtomic({commit:e,state:r},{itemData:t,userId:o,isAddingCartons:a=!0}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!["superadmin","warehouse_manager"].includes(r.userProfile.role))throw new Error("ليس لديك صلاحية لإضافة أصناف");if(!o)throw new Error("معرف المستخدم غير متوفر");const e=["name","code","color","warehouse_id"];for(const r of e)if(!t[r]?.trim())throw new Error(`الحقل ${r} مطلوب`);const n={name:t.name.trim(),code:t.code.trim(),color:t.color.trim(),warehouse_id:t.warehouse_id,cartons_count:Number(t.cartons_count)||0,per_carton_count:Number(t.per_carton_count)||(a?12:1),single_bottles_count:Number(t.single_bottles_count)||0,supplier:t.supplier?.trim()||"",item_location:t.item_location?.trim()||"",notes:t.notes?.trim()||""};if(a){if(n.cartons_count<0)throw new Error("عدد الكراتين لا يمكن أن يكون سالباً");if(n.per_carton_count<1)throw new Error("عدد القطع في الكرتونة يجب أن يكون 1 على الأقل")}else if(n.single_bottles_count<0)throw new Error("عدد القزاز الفردي لا يمكن أن يكون سالباً");console.log("Performing atomic item operation with data:",n);const s=(0,f.wP)(w.db),i=new Date,c=(0,f.rJ)(w.db,"items"),u=(0,f.P)(c,(0,f._M)("warehouse_id","==",n.warehouse_id),(0,f._M)("code","==",n.code),(0,f._M)("color","==",n.color),(0,f._M)("name","==",n.name)),l=await(0,f.GG)(u);let d;if(l.empty){console.log("Creating new item");const e=n.cartons_count||0,r=n.per_carton_count||1,t=n.single_bottles_count||0,a=e*r+t;if(a<=0)throw new Error("يجب إدخال كمية صحيحة");const c={name:n.name,code:n.code,color:n.color,warehouse_id:n.warehouse_id,cartons_count:e,per_carton_count:r,single_bottles_count:t,total_added:a,remaining_quantity:a,supplier:n.supplier,item_location:n.item_location,notes:n.notes,created_at:i,created_by:o,updated_at:i,updated_by:o},u=(0,f.H9)((0,f.rJ)(w.db,"items"));s.set(u,c);const l=(0,f.H9)((0,f.rJ)(w.db,"transactions"));s.set(l,{item_id:u.id,from_warehouse:null,to_warehouse:n.warehouse_id,type:E.t2.ADD,cartons_delta:e,single_delta:t,per_carton_updated:r,previous_remaining:0,new_remaining:a,timestamp:i,user_id:o,notes:n.notes||"إنشاء صنف جديد",created_at:i}),d={type:"created",id:u.id,addedQuantity:a}}else{const e=l.docs[0],r=e.data();console.log("Updating existing item:",e.id);const t={updated_at:i,updated_by:o};let c=0;if(a){const e=r.cartons_count||0,o=n.cartons_count||0;t.cartons_count=e+o,void 0!==n.per_carton_count&&null!==n.per_carton_count&&n.per_carton_count>=1?t.per_carton_count=n.per_carton_count:t.per_carton_count=r.per_carton_count||1;const a=t.per_carton_count;c=o*a,t.single_bottles_count=r.single_bottles_count||0}else void 0!==n.single_bottles_count&&null!==n.single_bottles_count?(t.single_bottles_count=(r.single_bottles_count||0)+n.single_bottles_count,c=n.single_bottles_count):t.single_bottles_count=r.single_bottles_count||0,t.cartons_count=r.cartons_count||0,t.per_carton_count=r.per_carton_count||1;const u=r.total_added||0,_=r.remaining_quantity||0;if(t.total_added=u+c,t.remaining_quantity=_+c,void 0!==n.notes&&(t.notes=n.notes),void 0!==n.supplier&&(t.supplier=n.supplier),void 0!==n.item_location&&(t.item_location=n.item_location),t.remaining_quantity<0)throw new Error("الكمية المتبقية لا يمكن أن تكون سالبة");const m=(0,f.H9)(w.db,"items",e.id);s.update(m,t);const h=(0,f.H9)((0,f.rJ)(w.db,"transactions"));s.set(h,{item_id:e.id,from_warehouse:null,to_warehouse:n.warehouse_id,type:E.t2.ADD,cartons_delta:a&&n.cartons_count||0,single_delta:a?0:n.single_bottles_count||0,per_carton_updated:n.per_carton_count,previous_remaining:_,new_remaining:t.remaining_quantity,timestamp:i,user_id:o,notes:n.notes||(a?"إضافة كراتين للمخزن":"إضافة قزاز فردي للمخزن"),created_at:i}),d={type:"updated",id:e.id,addedQuantity:c}}return await s.commit(),console.log(`Item ${d.type} successfully:`,d.id),d}catch(n){console.error("Error in atomic item operation:",n);const r=n.message||"حدث خطأ غير متوقع أثناء إضافة الصنف";throw e("SET_OPERATION_ERROR",r),n}finally{e("SET_OPERATION_LOADING",!1)}},async addInventoryItem({commit:e,state:r},{itemData:t,isAddingCartons:o=!0}){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!["superadmin","warehouse_manager"].includes(r.userProfile.role))throw new Error("ليس لديك صلاحية لإضافة أصناف");if(!r.user?.uid)throw new Error("معرف المستخدم غير متوفر");if(!t.name?.trim()||!t.code?.trim()||!t.color?.trim()||!t.warehouse_id)throw new Error("جميع الحقول المطلوبة يجب أن تكون مملوءة (الاسم، الكود، اللون، المخزن)");const e=E.cE.calculateTotalQuantity(t.cartons_count,t.per_carton_count,t.single_bottles_count);if(e<=0)throw new Error("يجب إدخال كمية صحيحة");const a={name:t.name.trim(),code:t.code.trim(),color:t.color.trim(),warehouse_id:t.warehouse_id,cartons_count:Number(t.cartons_count)||0,per_carton_count:Number(t.per_carton_count)||12,single_bottles_count:Number(t.single_bottles_count)||0,supplier:t.supplier?.trim()||"",item_location:t.item_location?.trim()||"",notes:t.notes?.trim()||""};console.log("Adding item with cleaned data:",a);const n=await E.cE.addOrUpdateItem(a,r.user.uid,o);return console.log(`Item ${n.type} successfully:`,n.id),n}catch(a){console.error("Error adding inventory item:",a);const r=a.message||"حدث خطأ غير متوقع أثناء إضافة الصنف";throw e("SET_OPERATION_ERROR",r),a}finally{e("SET_OPERATION_LOADING",!1)}},subscribeToInventory({commit:e,state:r}){if(r.userProfile){console.log("Subscribing to inventory...");try{const r=(0,f.P)((0,f.rJ)(w.db,"items"));return(0,f.aQ)(r,r=>{console.log("Inventory snapshot received:",r.size,"items");const t=r.docs.map(e=>{const r=e.data();return E.cE.convertForDisplay({id:e.id,...r})});console.log("Inventory loaded:",t.length,"items"),e("SET_INVENTORY",t)},e=>{console.error("Error in inventory subscription:",e),console.warn("Inventory subscription error:",e.message)})}catch(t){console.error("Error setting up inventory subscription:",t)}}else console.log("Cannot subscribe to inventory: User not authenticated")},subscribeToTransactions({commit:e,state:r}){if(r.userProfile){console.log("Subscribing to transactions...");try{const r=(0,f.P)((0,f.rJ)(w.db,"transactions"),(0,f.My)("timestamp","desc"));return(0,f.aQ)(r,r=>{console.log("Transactions snapshot received:",r.size,"transactions");const t=r.docs.map(e=>{const r=e.data();return{id:e.id,...r,_display:{from_warehouse:E.Qi[r.from_warehouse]||r.from_warehouse,to_warehouse:E.Qi[r.to_warehouse]||E.VX[r.to_warehouse]||r.to_warehouse}}});console.log("Transactions loaded:",t.length,"transactions"),e("SET_TRANSACTIONS",t)},r=>{console.error("Error in transactions subscription:",r),console.warn("Transactions subscription error:",r.message),e("SET_TRANSACTIONS",[])})}catch(t){console.error("Error setting up transactions subscription:",t),e("SET_TRANSACTIONS",[])}}else console.log("Cannot subscribe to transactions: User not authenticated")},async transferItem({commit:e,state:r},t){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!["superadmin","warehouse_manager"].includes(r.userProfile.role))throw new Error("ليس لديك صلاحية لنقل الأصناف");if(!r.user?.uid)throw new Error("معرف المستخدم غير متوفر");const e=await E.cE.transferItem(t,r.user.uid);return console.log("Transfer completed successfully:",e.transferQty),e}catch(o){throw console.error("Error transferring item:",o),e("SET_OPERATION_ERROR",o.message),o}finally{e("SET_OPERATION_LOADING",!1)}},async dispatchItem({commit:e,state:r},t){e("SET_OPERATION_LOADING",!0),e("CLEAR_OPERATION_ERROR");try{if(!r.userProfile)throw new Error("يجب تسجيل الدخول أولاً");if(!["superadmin","warehouse_manager"].includes(r.userProfile.role))throw new Error("ليس لديك صلاحية لصرف الأصناف");if(!r.user?.uid)throw new Error("معرف المستخدم غير متوفر");const e=await E.cE.dispatchItem(t,r.user.uid);return console.log("Dispatch completed successfully:",e.dispatchQty),e}catch(o){throw console.error("Error dispatching item:",o),e("SET_OPERATION_ERROR",o.message),o}finally{e("SET_OPERATION_LOADING",!1)}},updateFilters({commit:e},r){e("SET_FILTERS",r)},clearOperationError({commit:e}){e("CLEAR_OPERATION_ERROR")}},getters:{isAuthenticated:e=>!!e.user,userRole:e=>e.userProfile?.role,userName:e=>e.userProfile?.name||e.userProfile?.email?.split("@")[0],allowedWarehouses:e=>e.userProfile?.allowed_warehouses||[],userPermissions:e=>e.userProfile?.permissions||[],authError:e=>e.authError,operationError:e=>e.operationError,operationLoading:e=>e.operationLoading,fieldMappings:e=>e.fieldMappings,warehousesLoaded:e=>e.warehousesLoaded,canEdit:(e,r)=>["superadmin","warehouse_manager"].includes(r.userRole),canDelete:(e,r)=>"superadmin"===r.userRole||"warehouse_manager"===r.userRole&&(r.userPermissions.includes("full_access")||r.userPermissions.includes("delete_items")),canManageUsers:e=>"superadmin"===e.userProfile?.role,mainWarehouse:e=>e.warehouses.find(e=>e.is_main),primaryWarehouses:e=>e.warehouses.filter(e=>"primary"===e.type),dispatchWarehouses:e=>e.warehouses.filter(e=>"dispatch"===e.type),accessibleWarehouses:(e,r)=>{if(!e.warehousesLoaded)return[];if("superadmin"===r.userRole)return e.warehouses;if(["warehouse_manager","company_manager"].includes(r.userRole)){const t=r.allowedWarehouses;if(t&&t.length>0)return e.warehouses.filter(e=>t.includes(e.id))}return[]},filteredInventory:e=>{let r=e.inventory;if("warehouse_manager"===e.userProfile?.role||"company_manager"===e.userProfile?.role){const t=e.userProfile.allowed_warehouses||[];t.length>0&&(r=r.filter(e=>t.includes(e.warehouse_id)))}if(e.filters.search){const t=e.filters.search.toLowerCase();r=r.filter(e=>e.name?.toLowerCase().includes(t)||e.code?.toLowerCase().includes(t)||e.color?.toLowerCase().includes(t)||e.supplier?.toLowerCase().includes(t))}return e.filters.warehouse&&(r=r.filter(r=>r.warehouse_id===e.filters.warehouse)),r},dashboardStats:e=>{let r=e.inventory;if("warehouse_manager"===e.userProfile?.role||"company_manager"===e.userProfile?.role){const t=e.userProfile.allowed_warehouses||[];t.length>0&&(r=r.filter(e=>t.includes(e.warehouse_id)))}const t=r.length,o=r.reduce((e,r)=>e+(r.remaining_quantity||0),0),a=r.filter(e=>(e.remaining_quantity||0)<10).length,n=e.transactions.filter(e=>{if(!e.timestamp)return!1;const r=e.timestamp.toDate?e.timestamp.toDate():new Date(e.timestamp);return r>new Date(Date.now()-864e5)}).length;return{totalItems:t,totalQuantity:o,lowStockItems:a,recentTransactions:n}},getArabicLabel:e=>r=>e.fieldMappings.englishToArabic[r]||r,getWarehouseLabel:()=>e=>E.Qi[e]||e,getDestinationLabel:()=>e=>E.VX[e]||e}});function O(e){const r={"auth/invalid-email":"البريد الإلكتروني غير صحيح","auth/user-disabled":"هذا الحساب معطل","auth/user-not-found":"لا يوجد حساب بهذا البريد الإلكتروني","auth/wrong-password":"كلمة المرور غير صحيحة","auth/email-already-in-use":"هذا البريد الإلكتروني مستخدم بالفعل","auth/weak-password":"كلمة المرور ضعيفة","auth/network-request-failed":"خطأ في الاتصال بالشبكة. يرجى المحاولة مرة أخرى","auth/too-many-requests":"محاولات تسجيل دخول كثيرة. يرجى المحاولة لاحقاً","auth/configuration-not-found":"خطأ في إعدادات النظام. يرجى التواصل مع الدعم الفني"};return r[e]||"حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى"}const T=(0,o.Ef)(d);T.use(R),T.use(p),T.mount("#app")},556:function(e,r,t){t.d(r,{db:function(){return l},j2:function(){return u}});var o=t(223),a=t(496),n=t(884),s=t(904);const i={apiKey:"AIzaSyDxpbXvFH6UvfE2I6OJ_wNFnA889Zu-NEQ",authDomain:"monofia-inventory.firebaseapp.com",projectId:"monofia-inventory",storageBucket:"monofia-inventory.firebasestorage.app",messagingSenderId:"788480597316",appId:"1:788480597316:web:776a05277fb4e60806cb11"},c=(0,o.Wp)(i),u=(0,a.xI)(c),l=(0,n.aU)(c);(0,s.c7)(c);u.languageCode="ar"}},r={};function t(o){var a=r[o];if(void 0!==a)return a.exports;var n=r[o]={id:o,loaded:!1,exports:{}};return e[o].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}t.m=e,function(){var e=[];t.O=function(r,o,a,n){if(!o){var s=1/0;for(l=0;l<e.length;l++){o=e[l][0],a=e[l][1],n=e[l][2];for(var i=!0,c=0;c<o.length;c++)(!1&n||s>=n)&&Object.keys(t.O).every(function(e){return t.O[e](o[c])})?o.splice(c--,1):(i=!1,n<s&&(s=n));if(i){e.splice(l--,1);var u=a();void 0!==u&&(r=u)}}return r}n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[o,a,n]}}(),function(){t.d=function(e,r){for(var o in r)t.o(r,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:r[o]})}}(),function(){t.f={},t.e=function(e){return Promise.all(Object.keys(t.f).reduce(function(r,o){return t.f[o](e,r),r},[]))}}(),function(){t.u=function(e){return"js/"+e+"."+{176:"b4ec0373",217:"f6286c95",315:"6e667df7",502:"2ca3813d",513:"37cc27c1",523:"6fd2f555",569:"4b8213e0",621:"fe423d3a",630:"4171ded6",696:"14c87f30",848:"3410c80d",989:"8af61e56"}[e]+".js"}}(),function(){t.miniCssF=function(e){return"css/"+e+"."+{513:"32c23152",523:"23c2114f",569:"2f4bf41d",621:"4de43379",630:"8929d808",639:"a679d7fd",848:"3b7b0740",989:"062df114"}[e]+".css"}}(),function(){t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)}}(),function(){var e={},r="monofia-perfume-inventory:";t.l=function(o,a,n,s){if(e[o])e[o].push(a);else{var i,c;if(void 0!==n)for(var u=document.getElementsByTagName("script"),l=0;l<u.length;l++){var d=u[l];if(d.getAttribute("src")==o||d.getAttribute("data-webpack")==r+n){i=d;break}}i||(c=!0,i=document.createElement("script"),i.charset="utf-8",t.nc&&i.setAttribute("nonce",t.nc),i.setAttribute("data-webpack",r+n),i.src=o),e[o]=[a];var _=function(r,t){i.onerror=i.onload=null,clearTimeout(m);var a=e[o];if(delete e[o],i.parentNode&&i.parentNode.removeChild(i),a&&a.forEach(function(e){return e(t)}),r)return r(t)},m=setTimeout(_.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=_.bind(null,i.onerror),i.onload=_.bind(null,i.onload),c&&document.head.appendChild(i)}}}(),function(){t.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){t.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){t.p="/"}(),function(){if("undefined"!==typeof document){var e=function(e,r,o,a,n){var s=document.createElement("link");s.rel="stylesheet",s.type="text/css",t.nc&&(s.nonce=t.nc);var i=function(t){if(s.onerror=s.onload=null,"load"===t.type)a();else{var o=t&&t.type,i=t&&t.target&&t.target.href||r,c=new Error("Loading CSS chunk "+e+" failed.\n("+o+": "+i+")");c.name="ChunkLoadError",c.code="CSS_CHUNK_LOAD_FAILED",c.type=o,c.request=i,s.parentNode&&s.parentNode.removeChild(s),n(c)}};return s.onerror=s.onload=i,s.href=r,o?o.parentNode.insertBefore(s,o.nextSibling):document.head.appendChild(s),s},r=function(e,r){for(var t=document.getElementsByTagName("link"),o=0;o<t.length;o++){var a=t[o],n=a.getAttribute("data-href")||a.getAttribute("href");if("stylesheet"===a.rel&&(n===e||n===r))return a}var s=document.getElementsByTagName("style");for(o=0;o<s.length;o++){a=s[o],n=a.getAttribute("data-href");if(n===e||n===r)return a}},o=function(o){return new Promise(function(a,n){var s=t.miniCssF(o),i=t.p+s;if(r(s,i))return a();e(o,i,null,a,n)})},a={524:0};t.f.miniCss=function(e,r){var t={513:1,523:1,569:1,621:1,630:1,639:1,848:1,989:1};a[e]?r.push(a[e]):0!==a[e]&&t[e]&&r.push(a[e]=o(e).then(function(){a[e]=0},function(r){throw delete a[e],r}))}}}(),function(){var e={524:0};t.f.j=function(r,o){var a=t.o(e,r)?e[r]:void 0;if(0!==a)if(a)o.push(a[2]);else if(639!=r){var n=new Promise(function(t,o){a=e[r]=[t,o]});o.push(a[2]=n);var s=t.p+t.u(r),i=new Error,c=function(o){if(t.o(e,r)&&(a=e[r],0!==a&&(e[r]=void 0),a)){var n=o&&("load"===o.type?"missing":o.type),s=o&&o.target&&o.target.src;i.message="Loading chunk "+r+" failed.\n("+n+": "+s+")",i.name="ChunkLoadError",i.type=n,i.request=s,a[1](i)}};t.l(s,c,"chunk-"+r,r)}else e[r]=0},t.O.j=function(r){return 0===e[r]};var r=function(r,o){var a,n,s=o[0],i=o[1],c=o[2],u=0;if(s.some(function(r){return 0!==e[r]})){for(a in i)t.o(i,a)&&(t.m[a]=i[a]);if(c)var l=c(t)}for(r&&r(o);u<s.length;u++)n=s[u],t.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return t.O(l)},o=self["webpackChunkmonofia_perfume_inventory"]=self["webpackChunkmonofia_perfume_inventory"]||[];o.forEach(r.bind(null,0)),o.push=r.bind(null,o.push.bind(o))}();var o=t.O(void 0,[96],function(){return t(329)});o=t.O(o)})();