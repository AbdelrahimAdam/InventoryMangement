<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø®Ø§Ø²Ù† Ø²Ø¬Ø§Ø¬ Ø§Ù„Ø¹Ø·ÙˆØ± - Ø§Ù„Ø¨Ø±Ø§Ù† Ù„Ù„Ø¹Ø·ÙˆØ±" />

    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/img/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù†" />

    <!-- Microsoft Tiles -->
    <meta name="msapplication-TileColor" content="#3b82f6" />
    <meta name="msapplication-TileImage" content="/img/icons/mstile-150x150.png" />
    <meta name="msapplication-config" content="/browserconfig.xml" />

    <!-- Arabic font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />

    <!-- Theme Color -->
    <meta name="theme-color" content="#3b82f6" />
    <meta name="theme-color" content="#3b82f6" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1e40af" media="(prefers-color-scheme: dark)" />

    <!-- PWA manifest -->
    <link rel="manifest" href="/manifest.json" crossorigin="use-credentials" />

    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† - Ø§Ù„Ø¨Ø±Ø§Ù† Ù„Ù„Ø¹Ø·ÙˆØ±</title>

    <style>
      /* Loading styles - Critical CSS inlined */
      #app-loading {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 9999;
        font-family: "Tajawal", system-ui, -apple-system, sans-serif;
        transition: opacity 0.5s ease;
      }

      .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Critical body styles */
      body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        background: #f5f5f5;
        -webkit-tap-highlight-color: transparent;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Hide loading screen when Vue loads */
      body.vue-loaded #app-loading {
        opacity: 0;
        pointer-events: none;
      }

      /* Install button */
      #install-btn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        font-family: "Tajawal", sans-serif;
        transition: all 0.3s ease;
      }

      #install-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
      }

      /* Print styles */
      @media print {
        #app-loading,
        #install-btn {
          display: none !important;
        }
      }
    </style>
  </head>

  <body>
    <!-- Loading screen -->
    <div id="app-loading">
      <div class="loading-spinner"></div>
      <h2 style="margin-bottom: 10px; font-weight: 700;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h2>
      <p style="opacity: 0.8; margin-top: 0;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø²Ù† - Ø§Ù„Ø¨Ø±Ø§Ù† Ù„Ù„Ø¹Ø·ÙˆØ±</p>
    </div>

    <!-- Vue app root -->
    <div id="app"></div>

    <!-- PWA Install button -->
    <button id="install-btn" aria-label="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>

    <!-- Service Worker Management -->
    <script>
      // Clear old service workers before registering new one
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
          try {
            // Clean up any existing registrations first
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              await registration.unregister();
              console.log('ğŸ§¹ Unregistered old service worker:', registration.scope);
            }

            // Check if we're in production
            const isProduction = window.location.hostname !== 'localhost' && 
                                 window.location.hostname !== '127.0.0.1';

            if (isProduction) {
              // Try to register the service worker with retry logic
              const registerSW = async (retries = 3) => {
                try {
                  // First try the main service worker
                  const registration = await navigator.serviceWorker.register('/service-worker.js', {
                    scope: '/',
                    updateViaCache: 'none'
                  });

                  console.log('âœ… Service Worker registered successfully:', registration.scope);

                  // Listen for updates
                  registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    if (newWorker) {
                      newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                          console.log('ğŸ”„ New content is available; please refresh.');
                          
                          // Show update notification
                          if (window.confirm('ØªÙˆØ¬Ø¯ Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†ØŸ')) {
                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                            window.location.reload();
                          }
                        }
                      });
                    }
                  });

                  return registration;
                } catch (error) {
                  console.warn(`âŒ Service Worker registration attempt ${4 - retries} failed:`, error);
                  
                  if (retries > 0) {
                    // Wait 2 seconds before retry
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    return registerSW(retries - 1);
                  }
                  throw error;
                }
              };

              // Start registration
              await registerSW();
            } else {
              console.log('ğŸ”§ Development mode: Service Worker registration skipped');
            }
          } catch (error) {
            console.error('âŒ Service Worker registration failed after all attempts:', error);
          }
        });
      }

      // Auto-hide loader when Vue mounts
      (function() {
        const appDiv = document.getElementById('app');
        const maxWaitTime = 15000; // 15 seconds max wait
        let vueMounted = false;
        let checkInterval;

        const checkVueMount = function() {
          if (appDiv && appDiv.children.length > 0 && !vueMounted) {
            console.log('âœ… Vue mounted successfully');
            vueMounted = true;
            document.body.classList.add('vue-loaded');
            clearInterval(checkInterval);
            
            // Force hide after animation
            setTimeout(() => {
              const loadingEl = document.getElementById('app-loading');
              if (loadingEl) {
                loadingEl.style.display = 'none';
              }
            }, 500);
          }
        };

        // Start checking immediately
        checkInterval = setInterval(checkVueMount, 100);

        // Initial check
        setTimeout(checkVueMount, 100);

        // Timeout fallback
        setTimeout(function() {
          if (!vueMounted) {
            clearInterval(checkInterval);
            console.error('âŒ Vue did not mount in time');
            const loadingEl = document.getElementById('app-loading');
            if (loadingEl) {
              loadingEl.innerHTML = `
                <div style="padding: 20px; text-align: center; max-width: 90%;">
                  <h2 style="color: #fff; margin-bottom: 15px;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</h2>
                  <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px;">
                    ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.
                  </p>
                  <button onclick="window.location.reload()" 
                    style="padding: 10px 20px; background: white; color: #667eea; 
                           border: none; border-radius: 5px; margin: 10px;
                           font-family: 'Tajawal', sans-serif; font-weight: 500;
                           cursor: pointer;">
                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                  </button>
                  <button onclick="if(localStorage.clear())location.reload()" 
                    style="padding: 10px 20px; background: rgba(255,255,255,0.1); 
                           color: white; border: 1px solid rgba(255,255,255,0.3); 
                           border-radius: 5px; margin: 10px;
                           font-family: 'Tajawal', sans-serif; font-weight: 500;
                           cursor: pointer;">
                    ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
                  </button>
                </div>
              `;
            }
          }
        }, maxWaitTime);
      })();
    </script>

    <!-- PWA INSTALL PROMPT -->
    <script>
      (function() {
        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');
        let promptShown = false;

        // Handle install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          
          // Only show button if not already installed
          if (!window.matchMedia('(display-mode: standalone)').matches) {
            // Wait a bit before showing to avoid interrupting initial load
            setTimeout(() => {
              if (!promptShown && deferredPrompt) {
                installBtn.style.display = 'inline-block';
                promptShown = true;
              }
            }, 3000);
          }
        });

        // Install button click handler
        installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
            installBtn.disabled = true;
            installBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª...';
            
            try {
              deferredPrompt.prompt();
              const choice = await deferredPrompt.userChoice;
              
              if (choice.outcome === 'accepted') {
                console.log('âœ… User accepted the install prompt');
                installBtn.style.display = 'none';
              } else {
                console.log('âŒ User dismissed the install prompt');
                installBtn.innerHTML = 'ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
                installBtn.disabled = false;
                // Hide button for this session
                setTimeout(() => {
                  installBtn.style.display = 'none';
                }, 3000);
              }
              deferredPrompt = null;
            } catch (error) {
              console.error('âŒ Install prompt error:', error);
              installBtn.innerHTML = 'ğŸ“± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
              installBtn.disabled = false;
            }
          }
        });

        // Hide install button if app is already installed
        window.addEventListener('appinstalled', () => {
          console.log('ğŸ‰ App installed successfully');
          installBtn.style.display = 'none';
          deferredPrompt = null;
        });

        // Check if already installed on load
        if (window.matchMedia('(display-mode: standalone)').matches) {
          installBtn.style.display = 'none';
          console.log('ğŸ“± App running in standalone mode');
        }
      })();
    </script>

    <!-- Performance Monitoring -->
    <script>
      // Performance monitoring
      if (typeof window !== 'undefined') {
        // Report Web Vitals
        const reportWebVitals = (metric) => {
          console.log('ğŸ“Š Performance:', {
            name: metric.name,
            value: Math.round(metric.value),
            rating: metric.rating,
            delta: metric.delta
          });
        };

        // Load performance monitoring after app loads
        setTimeout(() => {
          if (window.performance && window.performance.getEntriesByType) {
            const navTiming = window.performance.getEntriesByType('navigation')[0];
            if (navTiming) {
              console.log('âš¡ Page Load Performance:', {
                'DOM Ready': Math.round(navTiming.domContentLoadedEventEnd - navTiming.domContentLoadedEventStart),
                'Page Load': Math.round(navTiming.loadEventEnd - navTiming.loadEventStart),
                'TTFB': Math.round(navTiming.responseStart - navTiming.requestStart)
              });
            }
          }
        }, 1000);
      }
    </script>
  </body>
</html>
